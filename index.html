<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart RPE Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --bg: #0f172a; --card-bg: #1e293b; --backoff-bg: #162032;
            --text: #f8fafc; --text-muted: #94a3b8; --border: #334155; --input-bg: #0f172a;
            --highlight: #22c55e; --danger: #ef4444; --active-tab: #2563eb;
            --prog-low: #ef4444; --prog-mid: #eab308; --prog-high: #22c55e;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); color: var(--text); padding: 1rem; max-width: 1200px; margin: 0 auto; padding-bottom: 4rem; }

        /* Navigation */
        .week-nav { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 1.5rem; scrollbar-width: none; }
        .week-nav::-webkit-scrollbar { display: none; }
        .week-btn { background: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.2s; flex: 1; text-align: center; min-width: 100px; }
        .week-btn.active { background: var(--active-tab); color: white; border-color: var(--active-tab); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }

        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        .top-nav-buttons { display: flex; gap: 10px; }

        /* Main Layout */
        .main-grid { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start; }
        .sidebar-wrapper { position: sticky; top: 20px; align-self: start; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; gap: 1rem; } .sidebar-wrapper { position: static; } #statsContainer { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; } }

        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        h2 { font-size: 1rem; margin-top: 0; color: var(--primary); margin-bottom: 1rem; }

        /* GRAPH CONTAINER */
        #graphView { display: none; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 1rem; }

        /* COLLAPSIBLE SECTIONS */
        .workout-section { margin-bottom: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .day-header { 
            background: rgba(59, 130, 246, 0.15); padding: 1rem; 
            font-weight: 800; font-size: 1.1rem; color: var(--primary); 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;
        }
        .day-header:hover { background: rgba(59, 130, 246, 0.25); }
        .header-content { display: flex; align-items: center; gap: 10px; width: 100%; }
        .arrow { transition: transform 0.3s ease; font-size: 0.8rem; margin-right: 10px; }
        
        .progress-wrapper { padding: 0 1rem; margin-top: 15px; margin-bottom: 5px; }
        .progress-container { width: 100%; height: 8px; background: var(--bg); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; width: 0%; background: var(--prog-low); transition: width 0.4s ease, background-color 0.4s ease; }
        .progress-label { font-size: 0.7rem; color: var(--text-muted); text-align: right; margin-bottom: 4px; display: block; }
        
        .check-all-btn { font-size: 0.75rem; color: var(--text-muted); text-decoration: underline; cursor: pointer; margin-left: auto; z-index: 10; padding: 5px; }
        
        .workout-section.collapsed .content { display: none; }
        .workout-section.collapsed .day-header { border-bottom: none; }
        .workout-section.collapsed .arrow { transform: rotate(-90deg); }
        .workout-section:not(.collapsed) .day-header { border-bottom: 1px solid var(--border); }
        .workout-section:not(.collapsed) .arrow { transform: rotate(0deg); }
        .content { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px;}
        th, td { padding: 0.8rem 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .ramp-row td { border-bottom: none !important; padding-bottom: 0.2rem; }
        .ramp-last-row td { border-bottom: 1px solid var(--border) !important; padding-bottom: 0.8rem; }
        .ramp-row + .ramp-row td { padding-top: 0.2rem; }
        .backoff-row { background-color: var(--backoff-bg); }
        .completed { opacity: 0.35; filter: grayscale(1); }

        .load-cell { font-size: 1.3rem; font-weight: 800; color: var(--highlight); cursor: pointer; text-decoration: underline dotted; }
        .actual-input { width: 65px !important; text-align: center; font-weight: bold; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: white; padding: 0.3rem; }
        
        .check-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .check-circle.checked { background: var(--highlight); border-color: var(--highlight); }
        .check-circle.checked::after { content: "âœ“"; color: white; font-weight: bold; }

        .btn-finish { width: 100%; padding: 1.2rem; background: var(--highlight); border: none; color: white; font-weight: 800; cursor: pointer; font-size: 1rem; margin-top: -1px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; }
        .plate { height: 70px; width: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: black; }
        .p-25 { background: #ef4444; height: 85px; } .p-20 { background: #3b82f6; height: 80px; } .p-15 { background: #eab308; height: 75px; } .p-10 { background: #22c55e; height: 65px; } .p-5 { background: #f8fafc; height: 55px; } .p-2-5 { background: #000; color: white; height: 45px; }
        .bar-shaft { width: 12px; height: 95px; background: #94a3b8; border-radius: 2px; }

        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="navbar">
    <h1>Smart RPE Pro</h1>
    <div class="top-nav-buttons">
        <button style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="toggleGraphView()">Graphs ðŸ“Š</button>
        <button style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="showHistory()">History</button>
    </div>
</div>

<div class="week-nav" id="navWeeks"></div>

<div class="main-grid">
    <div class="sidebar-wrapper">
        <div class="card">
            <h2>Your Maxes</h2>
            <div id="statsInputs"></div>
        </div>
        <div class="card">
            <h2>Rounding</h2>
            <select id="roundingMode" onchange="recalculateAll()">
                <option value="nearest">Nearest 2.5</option>
                <option value="up">Force Round Up</option>
                <option value="down">Force Round Down</option>
            </select>
        </div>
        <button onclick="resetChecks()" style="width:100%; padding:0.8rem; background:transparent; border:1px solid var(--danger); color:var(--danger); border-radius:8px; cursor:pointer; font-weight:600;">Reset Week Checks</button>
    </div>

    <div id="workoutDisplay">
        <div class="card" style="text-align:center;">
            <div class="loader"></div>
            <p>Connecting to Google Sheets...</p>
        </div>
    </div>

    <div id="graphView" style="display:none; width:100%;">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2>Program Analysis</h2>
                <div style="font-size:0.75rem; color:var(--text-muted)">
                    <span style="color:white; font-weight:bold">White Line</span> = Actual | 
                    <span style="text-decoration:dashed; border-bottom:1px dashed white">Dashed</span> = Target | 
                    <span style="opacity:0.5">Bar</span> = Volume
                </div>
            </div>
            <div id="graphLoader" style="font-size:0.8rem; color:var(--highlight); display:none;">Loading...</div>
        </div>

        <div class="card">
            <h2 style="color:#ef4444">1. Squat Overview</h2>
            <div class="chart-container"><canvas id="sqChart"></canvas></div>
        </div>

        <div class="card">
            <h2 style="color:#3b82f6">2. Bench Overview</h2>
            <div class="chart-container"><canvas id="bpChart"></canvas></div>
        </div>

        <div class="card">
            <h2 style="color:#22c55e">3. Deadlift Overview</h2>
            <div class="chart-container"><canvas id="dlChart"></canvas></div>
        </div>
    </div>
</div>

<div id="plateModal" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2 id="plateWeightTitle" style="text-align:center; font-size:2.5rem; margin-bottom:0.5rem;">0kg</h2>
        <div id="plateVisuals" style="display:flex; justify-content:center; align-items:center; gap:5px;"></div>
        <button style="width:100%; margin-top:30px; padding:1rem; background:var(--primary); color:white; border:none; border-radius:8px;" onclick="document.getElementById('plateModal').style.display='none'">Close</button>
    </div>
</div>

<div id="historyModal" class="modal-overlay" onclick="this.style.display='none'">
    <div class="modal-content" style="max-height:80vh; overflow-y:auto" onclick="event.stopPropagation()">
        <h2>Session History</h2>
        <div id="historyLogs"></div>
        <button style="width:100%; margin-top:10px; padding:0.8rem;" onclick="localStorage.removeItem('workout_history'); showHistory()">Clear History</button>
    </div>
</div>

<script>
    // ==========================================
    // ðŸ‘‡ CONFIGURE YOUR SHEET HERE ðŸ‘‡
    // ==========================================
    const SHEET_ID = "1uM-HgPoZxD79GUFfKuISO6bBgsIgPr7OSJYp4LrWJfU";
    const API_KEY = "AIzaSyAbSb2Ywku4lL_Tj65F1wCTiT4cWfxMV6M"; 
    // ==========================================

    const RPE_CHART = {
        1: {10:1, 9.5:0.978, 9:0.955, 8.5:0.939, 8:0.922, 7.5:0.907, 7:0.892, 6.5:0.878, 6:0.864},
        2: {10:0.955, 9.5:0.939, 9:0.922, 8.5:0.907, 8:0.892, 7.5:0.878, 7:0.864, 6.5:0.85, 6:0.837},
        3: {10:0.922, 9.5:0.907, 9:0.892, 8.5:0.878, 8:0.864, 7.5:0.85, 7:0.837, 6.5:0.824, 6:0.811},
        4: {10:0.892, 9.5:0.878, 9:0.864, 8.5:0.85, 8:0.837, 7.5:0.824, 7:0.811, 6.5:0.799, 6:0.788},
        5: {10:0.864, 9.5:0.85, 9:0.837, 8.5:0.824, 8:0.811, 7.5:0.799, 7:0.788, 6.5:0.776, 6:0.766},
        6: {10:0.837, 9.5:0.824, 9:0.811, 8.5:0.799, 8.5:0.799, 7.5:0.776, 7:0.766, 6.5:0.755, 6:0.744}
    };

    let activeTab = "";
    let allTabNames = []; 
    let fullProgramCache = null; 
    let charts = {}; 

    // GLOBAL CHART DEFAULTS
    Chart.defaults.interaction.mode = 'index';
    Chart.defaults.interaction.intersect = false;
    Chart.defaults.plugins.tooltip.enabled = true;

    window.onload = () => {
        initSidebar();
        fetchTabsAndInit();
    };

    function initSidebar() {
        const cont = document.getElementById('statsInputs');
        ['Squat', 'Bench Press', 'Deadlift'].forEach(l => {
            const val = localStorage.getItem('1rm_' + l) || 100;
            cont.innerHTML += `<div style="margin-bottom:10px"><label style="font-size:0.7rem; color:var(--text-muted)">${l}</label>
            <input type="number" value="${val}" oninput="localStorage.setItem('1rm_${l}', this.value); recalculateAll(); clearGraphCache();"></div>`;
        });
    }

    function clearGraphCache() { fullProgramCache = null; }

    async function fetchTabsAndInit() {
        if (!API_KEY || API_KEY.includes("PASTE")) {
            document.getElementById('workoutDisplay').innerHTML = '<div class="card" style="color:var(--danger)">Error: You need to add a Google API Key.</div>';
            return;
        }

        try {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const tabs = data.sheets.map(s => s.properties.title);
            allTabNames = tabs; 
            
            const nav = document.getElementById('navWeeks');
            nav.innerHTML = "";
            tabs.forEach(name => {
                const btn = document.createElement('button'); 
                btn.className = 'week-btn'; 
                btn.innerText = name;
                btn.onclick = () => loadTab(name); 
                nav.appendChild(btn);
            });

            if(tabs.length > 0) loadTab(tabs[0]);
        } catch (e) {
            document.getElementById('workoutDisplay').innerHTML = `<div class="card" style="color:var(--danger)">API Error: ${e.message}</div>`;
        }
    }

    // --- STANDARD WORKOUT LOADING ---
    function loadTab(tabName) {
        activeTab = tabName;
        document.getElementById('workoutDisplay').style.display = 'block';
        document.getElementById('graphView').style.display = 'none';
        
        document.querySelectorAll('.week-btn').forEach(b => b.classList.toggle('active', b.innerText === tabName));
        document.getElementById('workoutDisplay').innerHTML = '<div class="card" style="text-align:center"><div class="loader"></div><p>Fetching ' + tabName + '...</p></div>';
        
        const old = document.getElementById('sheetScript');
        if (old) old.remove();

        const timestamp = Date.now();
        const callbackName = 'cb_' + timestamp;

        window[callbackName] = (json) => {
            processSheet(json.table.rows);
            delete window[callbackName];
        };

        const script = document.createElement('script');
        script.id = 'sheetScript';
        script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${encodeURIComponent(tabName)}&headers=0&t=${timestamp}`;
        document.body.appendChild(script);
    }

    function processSheet(rows) {
        const display = document.getElementById('workoutDisplay');
        display.innerHTML = '';
        let currentSection = null; let tbody = null;

        rows.forEach((r, idx) => {
            const v = (i) => (r.c && r.c[i] && r.c[i].v !== null) ? String(r.c[i].v).trim() : "";
            const name = v(0), setsStr = v(1), rpeStr = v(3), note = v(4);
            const setsNum = parseInt(setsStr);

            if (name.toLowerCase() === 'exercise') return;

            if (name && (setsStr === "" || isNaN(setsNum))) {
                if (currentSection) display.appendChild(currentSection);
                currentSection = document.createElement('div'); 
                currentSection.className = 'workout-section collapsed'; 
                currentSection.innerHTML = `
                    <div class="day-header">
                        <div class="header-content" onclick="toggleSection(this)">
                            <span class="arrow">â–¼</span>
                            <span>${name}</span>
                        </div>
                        <span class="check-all-btn" onclick="toggleAllChecks(this)">Check All</span>
                    </div>
                    <div class="content">
                        <div class="progress-wrapper"><span class="progress-label">0%</span><div class="progress-container"><div class="progress-bar"></div></div></div>
                        <table><thead><tr><th style="width:30px"></th><th>Exercise</th><th>Target</th><th>Act.</th></tr></thead><tbody></tbody></table>
                        <button class="btn-finish" onclick="finishWorkout('${name}', this)">Finish Workout âœ…</button>
                    </div>`;
                tbody = currentSection.querySelector('tbody');
                return;
            }

            if (!tbody) return;

            const isRamp = note.toLowerCase().includes('ramp') || note.toLowerCase().includes('warmup');
            const id = `${activeTab}_${idx}`;

            if (isRamp && setsNum > 1) {
                for (let i = 1; i <= setsNum; i++) {
                    const label = (i === setsNum) ? "Top Set" : `Ramp ${i}`;
                    const dec = (setsNum - i) * 5;
                    const css = (i === 1) ? "ramp-row" : (i === setsNum) ? "ramp-last-row" : "ramp-row";
                    tbody.appendChild(createRow(name, 1, parseInt(v(2)), parseFloat(rpeStr), label, `${id}_r${i}`, dec, css));
                }
            } else if (rpeStr.includes('%') || rpeStr.startsWith('-')) {
                const drop = Math.abs(parseFloat(rpeStr.replace(/[^0-9.-]/g, ''))) || 10;
                tbody.appendChild(createBackoffRow(name, setsStr, parseInt(v(2)), drop, id));
            } else {
                tbody.appendChild(createRow(name, setsStr, parseInt(v(2)), parseFloat(rpeStr), note, id));
            }
        });
        if (currentSection) display.appendChild(currentSection);
        recalculateAll();
        document.querySelectorAll('.workout-section').forEach(sec => updateSectionProgress(sec));
    }

    function createRow(name, sets, reps, rpe, note, id, dec = 0, css = "") {
        const tr = document.createElement('tr'); tr.className = `main-row ${css}`;
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        if (checks[id]) tr.classList.add('completed');
        const pct = (RPE_CHART[reps] && RPE_CHART[reps][rpe]) ? RPE_CHART[reps][rpe] : 0;
        tr.innerHTML = `
            <td><div class="check-circle ${checks[id]?'checked':''}" data-id="${id}" onclick="toggleCheck(this)"></div></td>
            <td><div style="font-weight:bold">${name}</div><div style="font-size:0.75rem; color:var(--text-muted)">${note}</div></td>
            <td><div style="font-size:0.8rem">${sets}x${reps} @${rpe || 'N/A'}</div><div class="load-cell" data-ex="${name}" data-pct="${pct}" data-dec="${dec}" onclick="showPlates(this.innerText)">-</div></td>
            <td><input type="number" class="actual-input" placeholder="kg"></td>
        `;
        return tr;
    }

    function createBackoffRow(name, sets, reps, drop, id) {
        const tr = document.createElement('tr'); tr.className = 'backoff-row';
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        if (checks[id]) tr.classList.add('completed');
        tr.innerHTML = `
            <td><div class="check-circle ${checks[id]?'checked':''}" data-id="${id}" onclick="toggleCheck(this)"></div></td>
            <td><div style="font-weight:bold">${name}</div><div style="font-size:0.75rem; color:var(--text-muted)">Backoff (-${drop}%)</div></td>
            <td><div style="font-size:0.8rem">${sets}x${reps}</div><div class="load-cell backoff-calc" data-ex="${name}" data-drop="${drop}" onclick="showPlates(this.innerText)">-</div></td>
            <td><input type="number" class="actual-input" placeholder="kg"></td>
        `;
        return tr;
    }

    function recalculateAll() {
        const mode = document.getElementById('roundingMode').value;
        document.querySelectorAll('.load-cell:not(.backoff-calc)').forEach(cell => {
            const ex = cell.dataset.ex.toLowerCase(); const pct = parseFloat(cell.dataset.pct); const dec = parseFloat(cell.dataset.dec);
            let lift = null;
            if (ex.includes('squat')) lift = 'Squat'; 
            else if (ex.includes('bench')) lift = 'Bench Press'; 
            else if (ex.includes('deadlift')) lift = 'Deadlift';
            if (lift && pct > 0) {
                const max = parseFloat(localStorage.getItem('1rm_' + lift));
                let weight = (max * pct) - dec;
                if (mode === 'up') weight = Math.ceil(weight / 2.5) * 2.5;
                else if (mode === 'down') weight = Math.floor(weight / 2.5) * 2.5;
                else weight = Math.round(weight / 2.5) * 2.5;
                cell.innerText = weight + "kg";
                cell.closest('tr').setAttribute('data-last-wt', weight);
            }
        });
        document.querySelectorAll('.backoff-calc').forEach(cell => {
            const tr = cell.closest('tr');
            let prev = tr.previousElementSibling;
            while(prev && prev.classList.contains('backoff-row')) prev = prev.previousElementSibling;
            const base = prev ? parseFloat(prev.getAttribute('data-last-wt')) : 0;
            if (base) {
                let weight = base * (1 - parseFloat(cell.dataset.drop)/100);
                weight = Math.round(weight / 2.5) * 2.5;
                cell.innerText = weight + "kg";
            }
        });
    }

    function toggleSection(headerContent) { headerContent.closest('.workout-section').classList.toggle('collapsed'); }
    function updateSectionProgress(section) {
        const total = section.querySelectorAll('.check-circle').length;
        const checked = section.querySelectorAll('.check-circle.checked').length;
        const percentage = total === 0 ? 0 : Math.round((checked / total) * 100);
        const bar = section.querySelector('.progress-bar');
        const txt = section.querySelector('.progress-label');
        if(bar && txt) {
            bar.style.width = percentage + "%";
            txt.innerText = percentage + "% Completed";
            if (percentage <= 30) bar.style.backgroundColor = "var(--prog-low)";
            else if (percentage <= 70) bar.style.backgroundColor = "var(--prog-mid)";
            else bar.style.backgroundColor = "var(--prog-high)";
        }
    }
    function toggleCheck(el) {
        const id = el.dataset.id;
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        const tr = el.closest('tr');
        if (el.classList.contains('checked')) { delete checks[id]; el.classList.remove('checked'); tr.classList.remove('completed'); } 
        else { checks[id] = true; el.classList.add('checked'); tr.classList.add('completed'); }
        localStorage.setItem('checks', JSON.stringify(checks));
        updateSectionProgress(tr.closest('.workout-section'));
    }
    function toggleAllChecks(btn) {
        const section = btn.closest('.workout-section');
        const circles = section.querySelectorAll('.check-circle');
        const allChecked = Array.from(circles).every(c => c.classList.contains('checked'));
        circles.forEach(c => { if (allChecked) { if(c.classList.contains('checked')) toggleCheck(c); } else { if(!c.classList.contains('checked')) toggleCheck(c); }});
        updateSectionProgress(section);
    }
    function showPlates(txt) {
        const wt = parseFloat(txt); if (isNaN(wt)) return;
        document.getElementById('plateWeightTitle').innerText = wt + "kg";
        const vis = document.getElementById('plateVisuals'); vis.innerHTML = '<div class="bar-shaft"></div>';
        let side = (wt - 20) / 2;
        const plates = [{w:25,c:'p-25'},{w:20,c:'p-20'},{w:15,c:'p-15'},{w:10,c:'p-10'},{w:5,c:'p-5'},{w:2.5,c:'p-2-5'}];
        plates.forEach(p => { while(side >= p.w) { vis.innerHTML += `<div class="plate ${p.c}">${p.w}</div>`; side -= p.w; side = Math.round(side*100)/100; }});
        document.getElementById('plateModal').style.display = 'flex';
    }
    function resetChecks() { if (confirm("Clear checks?")) { localStorage.removeItem('checks'); location.reload(); }}
    function showHistory() {
        const logs = JSON.parse(localStorage.getItem('workout_history') || '[]');
        document.getElementById('historyLogs').innerHTML = logs.length ? logs.map(l => `<div class="card"><h4>${l.date} - ${l.day}</h4>${l.sets.map(s => `<div>${s.ex}: A:${s.actual}kg / T:${s.target}kg</div>`).join('')}</div>`).join('') : "Empty";
        document.getElementById('historyModal').style.display = 'flex';
    }
    function finishWorkout(day, btn) {
        const sets = [];
        btn.closest('.workout-section').querySelectorAll('tr').forEach(tr => {
            if (tr.querySelector('.check-circle.checked')) {
                const exName = tr.cells[1].innerText.split('\n')[0];
                const targetText = tr.querySelector('.load-cell').innerText.replace('kg','');
                const actualVal = tr.querySelector('.actual-input').value;
                sets.push({ ex: exName, target: targetText, actual: actualVal || targetText });
            }
        });
        if (!sets.length) return alert("Check sets.");
        const hist = JSON.parse(localStorage.getItem('workout_history') || '[]');
        hist.unshift({ date: new Date().toLocaleDateString(), day, sets });
        localStorage.setItem('workout_history', JSON.stringify(hist));
        alert("Workout Saved!");
    }

    // ==========================================
    // ðŸ“Š NEW COMBO GRAPH LOGIC (3 CHARTS)
    // ==========================================
    function toggleGraphView() {
        const wDisplay = document.getElementById('workoutDisplay');
        const gDisplay = document.getElementById('graphView');
        if (gDisplay.style.display === 'none') {
            wDisplay.style.display = 'none';
            gDisplay.style.display = 'block';
            loadFullProgramData();
        } else {
            gDisplay.style.display = 'none';
            wDisplay.style.display = 'block';
        }
    }

    async function loadFullProgramData() {
        if (fullProgramCache) { renderGraphs(fullProgramCache); return; }
        if (!allTabNames.length) return;

        document.getElementById('graphLoader').style.display = 'block';

        const tabsToFetch = allTabNames.slice(0, 16); 
        const ranges = tabsToFetch.map(t => `ranges=${encodeURIComponent(t)}!A:E`).join('&');
        
        try {
            const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?${ranges}&key=${API_KEY}`);
            const json = await res.json();
            
            if (!json.valueRanges) throw new Error("No data returned");

            const results = {}; 
            
            json.valueRanges.forEach(rangeObj => {
                const fullTitle = rangeObj.range; 
                const tabName = fullTitle.split('!')[0].replace(/'/g, "");
                
                const rows = rangeObj.values;
                if(!rows) return;

                let maxS = 0, maxB = 0, maxD = 0;
                let volS = 0, volB = 0, volD = 0;
                
                rows.forEach(r => {
                    if(!r[0]) return;
                    const name = r[0].toLowerCase();
                    const sets = parseInt(r[1]) || 0;
                    const reps = parseInt(r[2]) || 0;
                    const rpeStr = String(r[3]).trim();
                    
                    if (name.includes('exercise')) return;
                    
                    let pct = 0;
                    let rpeVal = parseFloat(rpeStr.replace(/[^0-9.]/g, ''));
                    if(rpeStr.includes('%') || rpeVal > 10) pct = rpeVal / 100;
                    else if(RPE_CHART[reps] && RPE_CHART[reps][rpeVal]) pct = RPE_CHART[reps][rpeVal];
                    if(isNaN(pct)) pct = 0;
                    
                    if (pct > 0) {
                        let w = 0;
                        if (name.includes('squat')) {
                            w = parseFloat(localStorage.getItem('1rm_Squat')||100) * pct;
                            if(w > maxS) maxS = w;
                            volS += (sets * reps * w);
                        } else if (name.includes('bench')) {
                            w = parseFloat(localStorage.getItem('1rm_Bench Press')||100) * pct;
                            if(w > maxB) maxB = w;
                            volB += (sets * reps * w);
                        } 
                        else if (name.includes('deadlift') || name.match(/\bdl\b/) || name.includes('pull')) {
                            w = parseFloat(localStorage.getItem('1rm_Deadlift')||100) * pct;
                            if(w > maxD) maxD = w;
                            volD += (sets * reps * w);
                        }
                    }
                });

                results[tabName] = { 
                    s: maxS > 0 ? Math.round(maxS/2.5)*2.5 : 0, 
                    b: maxB > 0 ? Math.round(maxB/2.5)*2.5 : 0, 
                    d: maxD > 0 ? Math.round(maxD/2.5)*2.5 : 0,
                    volS: volS > 0 ? Math.round(volS) : 0,
                    volB: volB > 0 ? Math.round(volB) : 0,
                    volD: volD > 0 ? Math.round(volD) : 0
                };
            });

            fullProgramCache = { tabs: tabsToFetch, data: results };
            renderGraphs(fullProgramCache);
            document.getElementById('graphLoader').style.display = 'none';

        } catch(e) {
            console.error(e);
            alert("Could not load full program: " + e.message);
        }
    }

    function renderGraphs(programData) {
        const labels = programData.tabs; 
        
        // 1. DATA PREP (Fill Forward)
        const buildSeries = (key) => {
            const arr = [];
            labels.forEach(l => arr.push(programData.data[l] ? programData.data[l][key] : 0));
            let firstVal = 0;
            for(let i=0; i<arr.length; i++) { if(arr[i] > 0) { firstVal = arr[i]; break; } }
            let lastVal = firstVal;
            return arr.map(val => { if (val > 0) { lastVal = val; return val; } else { return lastVal; } });
        };

        const tgtS = buildSeries('s');
        const tgtB = buildSeries('b');
        const tgtD = buildSeries('d');
        const vS = buildSeries('volS');
        const vB = buildSeries('volB');
        const vD = buildSeries('volD');

        // Actuals
        const hist = JSON.parse(localStorage.getItem('workout_history') || '[]');
        const actS = new Array(labels.length).fill(null);
        const actB = new Array(labels.length).fill(null);
        const actD = new Array(labels.length).fill(null);

        hist.forEach(h => {
            const idx = labels.indexOf(h.day); 
            if (idx !== -1) {
                h.sets.forEach(s => {
                    const val = parseFloat(s.actual);
                    if (!val) return;
                    const n = s.ex.toLowerCase();
                    if (n.includes('squat') && val > (actS[idx]||0)) actS[idx] = val;
                    if (n.includes('bench') && val > (actB[idx]||0)) actB[idx] = val;
                    if (n.includes('deadlift') && val > (actD[idx]||0)) actD[idx] = val;
                });
            }
        });

        // 2. HELPER TO CREATE DUAL AXIS CHARTS
        const createDualChart = (ctxId, label, color, tgtData, actData, volData) => {
            const ctx = document.getElementById(ctxId).getContext('2d');
            if (charts[ctxId]) charts[ctxId].destroy();
            
            charts[ctxId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'Volume (Right)', 
                            data: volData, 
                            type: 'bar',
                            yAxisID: 'y1', 
                            backgroundColor: color, 
                            opacity: 0.3,
                            barPercentage: 0.5
                        },
                        { 
                            label: 'Target Weight (Left)', 
                            data: tgtData, 
                            borderColor: color, 
                            borderDash: [5,5], 
                            pointRadius: 4, 
                            pointHitRadius: 20, 
                            tension: 0.2, 
                            yAxisID: 'y' 
                        },
                        { 
                            label: 'Actual Weight (Left)', 
                            data: actData, 
                            borderColor: '#ffffff', // WHITE ACTUAL LINE
                            backgroundColor: '#ffffff', 
                            pointRadius: 6, 
                            pointHitRadius: 20, 
                            spanGaps: true, 
                            yAxisID: 'y' 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: {
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            beginAtZero: true, // START AT 0
                            title: {display: true, text: 'Max Weight (kg)'},
                            grid: { color: '#334155' }
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            beginAtZero: true,
                            title: {display: true, text: 'Volume (kg)'},
                            grid: { drawOnChartArea: false } // clean look
                        }
                    }
                }
            });
        };

        createDualChart('sqChart', 'Squat', '#ef4444', tgtS, actS, vS);
        createDualChart('bpChart', 'Bench', '#3b82f6', tgtB, actB, vB);
        createDualChart('dlChart', 'Deadlift', '#22c55e', tgtD, actD, vD);
    }
</script>
</body>
</html>
