<!DOCTYPE html>
<!--
File: /c:/Users/flo/Documents/sheetsversion.html
Purpose:
    - Single-file web UI for viewing and interacting with a Google Sheetsâ€‘backed training program (Smart RPE Pro).
    - Presents weekly navigation, per-day collapsible workouts, progress tracking, and program analysis charts (Squat, Bench, Deadlift).
    - Supports entering "actual" lifts, checking sets as completed, viewing plate breakdowns, and persisting session history locally.

Quick configuration:
    - Set SHEET_ID and API_KEY constants near the top of the script to connect to your Google Sheets data.
        * Do NOT commit API keys to public repos; prefer server-side proxy or environment variables for production.
    - Rounding behavior selectable via the #roundingMode select (nearest / up / down).

High-level structure:
    - CSS variables (under :root) define theme colors, component backgrounds, progress bar colors and danger/active highlights.
    - Layout:
        * .navbar: top controls (Graphs/History).
        * .week-nav: horizontal week selector buttons.
        * .main-grid: two-column layout with left sidebar (maxes, rounding, reset) and right content (workouts or graphs).
        * #workoutDisplay: main area where workouts are rendered.
        * #graphView: separate layout for charts (sqChart, bpChart, dlChart).
    - Modals:
        * #plateModal: visual plate breakdown for a selected weight.
        * #historyModal: session history viewer; stored in localStorage key 'workout_history'.

Styling & responsiveness:
    - Uses a compact responsive grid; switches to a single column under 900px.
    - Custom components: card, workout-section (collapsible), progress bars, check circles, loader spinner.
    - Accessibility considerations:
        * Buttons and controls use visible focusable areas, but consider adding ARIA roles and keyboard handlers for collapsible sections and modal focus trapping.

Data model & runtime globals:
    - RPE_CHART: local conversion table mapping RPE and reps to a multiplier (used for intensity calculations).
    - Globals declared:
        * activeTab: currently selected week/day identifier.
        * allTabNames: array of week/day names.
        * fullProgramCache: in-memory cache for parsed program data from the sheet.
        * charts: container for Chart.js instances keyed by chart id.
    - Chart.js defaults are set for interaction (index mode, non-intersecting).

Expected behaviors (functions referenced in HTML):
    - toggleGraphView(): switch between workout list and graph analysis view.
    - showHistory(): open #historyModal and populate #historyLogs from localStorage.
    - recalculateAll(): re-run rounding/weight calculations when rounding mode or maxes change.
    - resetChecks(): clear all per-week "checked/completed" set markers.
    - Plate modal: clicking a weight display opens #plateModal with a visual plate stack for that weight.
    - Workout checkboxes / check-circle UI: toggles completion and triggers progress bar updates and history saves.

Persistence & history:
    - Session history is saved into localStorage (key: 'workout_history').
    - "Clear History" removes that localStorage key and refreshes the view.

Security & operational notes:
    - Avoid embedding API_KEY in client-side code for production; use a server-side endpoint to sign requests or proxy calls.
    - Google Sheets APIs may require CORS and correct API key / access permissions on the spreadsheet.
    - Add error handling around network requests (timeouts, auth errors) and graceful UI fallbacks if the sheet cannot be read.

Extending the app:
    - Add additional charts by creating new canvas elements and registering Chart.js datasets into charts[].
    - Support additional lifts or program metadata by extending parsing logic that maps sheet rows to the app's internal program format (cached in fullProgramCache).
    - Improve accessibility: keyboard navigation for week buttons, focus trapping inside modals, and ARIA attributes for dynamic content.

Debugging tips:
    - Inspect fullProgramCache in console to verify parsed sheet data structure.
    - Check charts object to access Chart instances for dataset inspection/updating.
    - Watch network requests in the browser devtools to verify sheet fetches and API key usage.

License & attribution:
    - This file includes custom UI/CSS and uses Chart.js (external library). Follow Chart.js license and any other third-party license requirements when redistributing.
-->
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart RPE Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3b82f6; --bg: #0f172a; --card-bg: #1e293b; --backoff-bg: #162032;
            --text: #f8fafc; --text-muted: #94a3b8; --border: #334155; --input-bg: #0f172a;
            --highlight: #22c55e; --danger: #ef4444; --active-tab: #2563eb;
            --prog-low: #ef4444; --prog-mid: #eab308; --prog-high: #22c55e;
        }
        /* Light theme (alternative) */
        .theme-light {
            --bg: #f8fafc; --card-bg: #ffffff; --text: #0f172a; --text-muted: #475569; --border: #e2e8f0; --input-bg: #f1f5f9;
            --primary: #2563eb; --highlight: #16a34a; --prog-low: #ef4444; --prog-mid: #f59e0b; --prog-high: #16a34a;
        }
        /* Muted/solarized-like theme */
        .theme-solar {
            --bg: #03202b; --card-bg: #073744; --text: #e6f6f9; --text-muted: #8fb3bd; --border: #0b4a58; --input-bg: #072630;
            --primary: #0ea5a4; --highlight: #ffd166; --prog-low: #ff6b6b; --prog-mid: #f59e0b; --prog-high: #22c55e;
        }

        body { font-family: -apple-system, system-ui, sans-serif; background-color: var(--bg); color: var(--text); padding: 1rem; max-width: 1200px; margin: 0 auto; padding-bottom: 4rem; }

        /* Navigation */
        .week-nav { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 1.5rem; scrollbar-width: none; }
        .week-nav::-webkit-scrollbar { display: none; }
        .week-btn { background: var(--card-bg); color: var(--text-muted); border: 1px solid var(--border); padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; white-space: nowrap; font-weight: 600; transition: 0.2s; flex: 1; text-align: center; min-width: 100px; }
        .week-btn.active { background: var(--active-tab); color: white; border-color: var(--active-tab); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4); }

        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        /* small helper to group header buttons */
        .top-nav-buttons { display:flex; gap:8px; align-items:center; }

        /* Main Layout
           - default: sidebar hidden -> single column
           - when .sidebar-open is present on .main-grid, show two columns */
        .main-grid { display: grid; grid-template-columns: 1fr; gap: 2rem; align-items: start; transition: grid-template-columns 220ms ease; }
        .main-grid.sidebar-open { grid-template-columns: 280px 1fr; }
        .sidebar-wrapper { display: none; } /* hidden by default */
        .main-grid.sidebar-open .sidebar-wrapper { display: block; position: sticky; top: 20px; align-self: start; }

        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; gap: 1rem; } .sidebar-wrapper { position: static; } #statsContainer { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; } }

        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
        h2 { font-size: 1rem; margin-top: 0; color: var(--primary); margin-bottom: 1rem; }

        /* GRAPH CONTAINER */
        #graphView { display: none; }
        .chart-container { position: relative; height: 300px; width: 100%; margin-bottom: 1rem; }

        /* COLLAPSIBLE SECTIONS */
        .workout-section { margin-bottom: 1rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; transition: all 0.3s ease; }
        .day-header { 
            background: rgba(59, 130, 246, 0.15); padding: 1rem; 
            font-weight: 800; font-size: 1.1rem; color: var(--primary); 
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;
        }
        .day-header:hover { background: rgba(59, 130, 246, 0.25); }
    .header-content { display: flex; align-items: center; gap: 10px; }
    /* header-right removed (no longer used) */
        .arrow { transition: transform 0.3s ease; font-size: 0.8rem; margin-right: 10px; }
        
    /* center-aligned, equal-length progress area */
    .progress-wrapper { padding: 0 12px; margin: 0; flex: 1 1 420px; min-width: 220px; max-width: 420px; display: flex; align-items: center; gap: 8px; box-sizing: border-box; margin-left: auto; }
        .progress-container { flex: 1 1 auto; height: 8px; background: var(--bg); border-radius: 10px; overflow: hidden; position: relative; }
        .progress-bar { height: 100%; width: 0%; background: var(--prog-low); transition: width 0.35s ease, background-color 0.35s ease; }
        /* inline numeric percentage, right-aligned so digits line up across rows */
        .progress-label { font-size: 0.8rem; color: var(--text-muted); margin: 0; display: inline-block; min-width: 36px; text-align: right; }

        /* Responsive: shrink progress width on small screens and stack right controls */
        @media (max-width: 600px) {
            /* allow progress area to shrink on smaller screens while keeping label inline */
            .progress-wrapper { min-width: 140px; max-width: 220px; flex: 1 1 220px; }
            .header-right { flex-direction: row; align-items: center; gap: 10px; }
            .progress-label { margin-bottom: 0; }
        }
        
        .check-all-btn { font-size: 0.75rem; color: var(--text-muted); text-decoration: underline; cursor: pointer; margin-left: auto; z-index: 10; padding: 5px; }
        
        .workout-section.collapsed .content { display: none; }
        .workout-section.collapsed .day-header { border-bottom: none; }
        .workout-section.collapsed .arrow { transform: rotate(-90deg); }
        .workout-section:not(.collapsed) .day-header { border-bottom: 1px solid var(--border); }
        .workout-section:not(.collapsed) .arrow { transform: rotate(0deg); }
        .content { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; margin-top: 10px;}
        th, td { padding: 0.8rem 0.5rem; text-align: left; border-bottom: 1px solid var(--border); }
        th { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }

        .ramp-row td { border-bottom: none !important; padding-bottom: 0.2rem; }
        .ramp-last-row td { border-bottom: 1px solid var(--border) !important; padding-bottom: 0.8rem; }
        .ramp-row + .ramp-row td { padding-top: 0.2rem; }
        .backoff-row { background-color: var(--backoff-bg); }
        .completed { opacity: 0.35; filter: grayscale(1); }

        .load-cell { font-size: 1.3rem; font-weight: 800; color: var(--highlight); cursor: pointer; text-decoration: underline dotted; }
        .actual-input { width: 65px !important; text-align: center; font-weight: bold; border: 1px solid var(--border); border-radius: 4px; background: var(--input-bg); color: white; padding: 0.3rem; }
    /* Sidebar max input tweak */
    .max-input { width: 90px !important; font-weight: 700; }
        /* Preference selects styling to match inputs */
        .pref-select { background: var(--input-bg); color: var(--text); border: 1px solid var(--border); padding: 0.4rem 0.5rem; border-radius: 6px; }
        
        .check-circle { width: 26px; height: 26px; border-radius: 50%; border: 2px solid var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
    .check-circle:focus { outline: 3px solid rgba(34,197,94,0.25); box-shadow: 0 0 0 3px rgba(34,197,94,0.12); }
    .actual-input:focus { outline: 2px solid rgba(59,130,246,0.2); box-shadow: 0 0 0 3px rgba(37,99,235,0.06); }
        .check-circle.checked { background: var(--highlight); border-color: var(--highlight); }
        .check-circle.checked::after { content: "âœ“"; color: white; font-weight: bold; }

        .btn-finish { width: 100%; padding: 1.2rem; background: var(--highlight); border: none; color: white; font-weight: 800; cursor: pointer; font-size: 1rem; margin-top: -1px; }
        
        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; width: 90%; max-width: 450px; }
        .plate { height: 70px; width: 18px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: black; }
        .p-25 { background: #ef4444; height: 85px; } .p-20 { background: #3b82f6; height: 80px; } .p-15 { background: #eab308; height: 75px; } .p-10 { background: #22c55e; height: 65px; } .p-5 { background: #f8fafc; height: 55px; } .p-2-5 { background: #000; color: white; height: 45px; }
    /* smaller fractional plates for IPF (1.25, 0.5) */
    .p-1-25 { background: #cbd5e1; height: 38px; font-size:9px; }
    .p-0-5 { background: #94a3b8; height: 30px; font-size:9px; color:white }
    /* clip visuals (collars) - small decorative (not used for plate rendering) */
    .clip { width: 12px; height: 28px; background: #bdbdbd; border-radius: 2px; display: inline-block; margin: 0 6px; box-shadow: inset 0 0 0 2px rgba(0,0,0,0.08); }
    /* clip-plate: visually a 2.5kg plate but styled differently and always placed outermost */
    .clip-plate { background: #6b7280; color: white; height: 45px; font-size: 10px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: 800; margin-left: 6px; box-shadow: 0 1px 0 rgba(0,0,0,0.4); }
        .bar-shaft { width: 12px; height: 95px; background: #94a3b8; border-radius: 2px; }

        .loader { border: 4px solid rgba(255,255,255,0.1); border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
<style>
    /* Fullscreen settings view for mobile */
    #settingsView { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100vh; background: var(--bg); display: none; z-index: 3000; padding: 1rem; box-sizing: border-box; overflow:auto; }
    #settingsView .card { max-width: 900px; margin: 0 auto; }
    /* When sidebar is moved into the settings view it must be visible (override default .sidebar-wrapper rule) */
    #settingsView .sidebar-wrapper { display: block !important; position: static !important; width: 100%; }
    #settingsView .sidebar-wrapper .card { margin-bottom: 1rem; }
    /* Generic fullscreen overlay class for graphs/history/settings */
    .overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; width: 100%; height: 100vh; background: var(--bg); z-index: 3000; padding: 1rem; box-sizing: border-box; overflow:auto; }
    .modal-overlay.fullscreen { background: var(--bg); }
    .modal-overlay.fullscreen .modal-content { width: 100%; max-width: 100%; height: 100vh; max-height: 100vh; border-radius: 0; padding: 1rem; box-sizing: border-box; overflow:auto; }
</style>
</head>
<body>

<div class="navbar">
    <h1>Smart RPE Pro</h1>
    <div class="top-nav-buttons">
    <button style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="toggleGraphView()">Graphs</button>
        <button style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="showHistory()">History</button>
    <button id="expandToggleBtn" style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="toggleExpandToggle()">Expand All</button>
    <button id="settingsBtn" style="background:var(--card-bg); color:white; border:1px solid var(--border); padding:0.5rem 1rem; border-radius:6px; cursor:pointer;" onclick="toggleSettings()">Settings</button>
    </div>
</div>

<div class="week-nav" id="navWeeks"></div>

<div class="main-grid">
    <div class="sidebar-wrapper">
    <div class="card">
            <h2>Your Maxes</h2>
            <div id="statsInputs"></div>
        </div>
        <!-- Rounding moved into Preferences below -->
            <div class="card">
                <h2>Preferences</h2>
                <div style="display:flex; flex-direction:column; gap:8px;">
                    <!-- Units removed: app uses kg internally and displays numeric weights without unit suffix -->

                    <div style="font-size:0.9rem; color:var(--text-muted)">
                                <div style="margin-bottom:6px; font-weight:600">Rounding step</div>
                                <select id="roundStep" class="pref-select" onchange="setRoundingStep(this.value)">
                                    <option value="none">No rounding</option>
                                    <option value="0.5">0.5</option>
                                    <option value="2.5">2.5</option>
                                    <option value="5">5</option>
                                </select>
                    </div>

                    <div style="font-size:0.9rem; color:var(--text-muted)">
                        <div style="margin-bottom:6px; font-weight:600">Theme</div>
                        <select id="themeSelect" class="pref-select" onchange="setTheme(this.value)">
                            <option value="default">Default</option>
                            <option value="light">Light</option>
                            <option value="solar">Solar</option>
                        </select>
                    </div>
                    <div style="font-size:0.9rem; color:var(--text-muted)">
                        <div style="margin-bottom:6px; font-weight:600">Rounding mode</div>
                        <select id="roundingMode" class="pref-select" onchange="setRoundingMode(this.value)">
                            <option value="nearest">Nearest (step)</option>
                            <option value="up">Force Round Up</option>
                            <option value="down">Force Round Down</option>
                        </select>
                    </div>
                </div>
            </div>
        <button onclick="resetChecks()" style="width:100%; padding:0.8rem; background:transparent; border:1px solid var(--danger); color:var(--danger); border-radius:8px; cursor:pointer; font-weight:600;">Reset Week Checks</button>
    </div>

    <div id="workoutDisplay">
        <div class="card" style="text-align:center;">
            <div class="loader"></div>
            <p>Connecting to Google Sheets...</p>
        </div>
    </div>

    <div id="graphView" style="display:none; width:100%;">
        <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
            <div>
                <h2>Program Analysis</h2>
                <div style="font-size:0.75rem; color:var(--text-muted)">
                    <span style="color:white; font-weight:bold">White Line</span> = Actual | 
                    <span style="text-decoration:dashed; border-bottom:1px dashed white">Dashed</span> = Target | 
                    <span style="opacity:0.5">Bar</span> = Volume
                </div>
            </div>
            <div style="display:flex; gap:12px; align-items:center">
                <div id="graphLoader" style="font-size:0.8rem; color:var(--highlight); display:none;">Loading...</div>
                <button id="graphBackBtn" style="background:var(--card-bg); color:var(--text); border:1px solid var(--border); padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;" onclick="closeGraphView()">Back</button>
            </div>
        </div>

        <div class="card">
            <h2 style="color:#ef4444">1. Squat Overview</h2>
            <div class="chart-container"><canvas id="sqChart"></canvas></div>
        </div>

        <div class="card">
            <h2 style="color:#3b82f6">2. Bench Overview</h2>
            <div class="chart-container"><canvas id="bpChart"></canvas></div>
        </div>

        <div class="card">
            <h2 style="color:#22c55e">3. Deadlift Overview</h2>
            <div class="chart-container"><canvas id="dlChart"></canvas></div>
        </div>
    </div>

    <!-- Mobile settings view: on small screens we temporarily move the sidebar here -->
    <div id="settingsView" style="display:none; width:100%;">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h2>Settings</h2>
                <button id="settingsBackBtn" style="background:var(--card-bg); color:var(--text); border:1px solid var(--border); padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;" onclick="closeSettingsView()">Back</button>
            </div>
            <div id="settingsContainer" style="margin-top:12px;"></div>
        </div>
    </div>
</div>

<div id="plateModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true" onclick="closeModal('plateModal')">
    <div class="modal-content" onclick="event.stopPropagation()" tabindex="-1">
    <h2 id="plateWeightTitle" style="text-align:center; font-size:2.5rem; margin-bottom:0.5rem;">0</h2>
        <div id="plateVisuals" style="display:flex; justify-content:center; align-items:center; gap:5px;"></div>
        <div style="display:flex; gap:8px; margin-top:12px;">
            <button id="clipsToggleBtn" style="flex:1; padding:0.6rem; background:var(--card-bg); border:1px solid var(--border); color:var(--text); border-radius:6px; cursor:pointer;" onclick="toggleClips()">Clips: Off</button>
        </div>
        <button id="plateCloseBtn" style="width:100%; margin-top:30px; padding:1rem; background:var(--primary); color:white; border:none; border-radius:8px;" onclick="closeModal('plateModal')">Close</button>
    </div>
</div>

<div id="historyModal" class="modal-overlay" role="dialog" aria-modal="true" aria-hidden="true" onclick="closeModal('historyModal')">
    <div class="modal-content" style="max-height:80vh; overflow-y:auto" onclick="event.stopPropagation()" tabindex="-1">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <h2 style="margin:0;">Session History</h2>
            <button id="historyBackBtn" style="background:var(--card-bg); color:var(--text); border:1px solid var(--border); padding:0.4rem 0.8rem; border-radius:6px; cursor:pointer;" onclick="closeHistoryView()">Back</button>
        </div>
        <div id="historyLogs"></div>
        <div style="display:flex; gap:8px; margin-top:10px;">
            <button id="exportHistoryBtn" style="flex:1; padding:0.8rem; background:var(--card-bg); border:1px solid var(--border); color:var(--text);" onclick="exportHistoryCSV()">Export CSV</button>
            <button id="importHistoryBtn" style="flex:1; padding:0.8rem; background:var(--card-bg); border:1px solid var(--border); color:var(--text);" onclick="triggerImportHistory()">Import CSV</button>
            <button id="clearHistoryBtn" style="flex:1; padding:0.8rem; background:transparent; border:1px solid var(--danger); color:var(--danger);" onclick="localStorage.removeItem('workout_history'); showHistory()">Clear History</button>
            <input id="importHistoryInput" type="file" accept=".csv,text/csv" style="display:none" onchange="handleHistoryFileChange(event)">
        </div>
            <button id="historyCloseBtn" style="width:100%; margin-top:10px; padding:0.8rem;" onclick="closeHistoryView()">Close</button>
    </div>
</div>

<script>
    // ==========================================
    // ðŸ‘‡ CONFIGURE YOUR SHEET HERE ðŸ‘‡
    // ==========================================
    const SHEET_ID = "1uM-HgPoZxD79GUFfKuISO6bBgsIgPr7OSJYp4LrWJfU";
    const API_KEY = "AIzaSyAbSb2Ywku4lL_Tj65F1wCTiT4cWfxMV6M"; 
    // ==========================================

    const RPE_CHART = {
        1: {10:1, 9.5:0.978, 9:0.955, 8.5:0.939, 8:0.922, 7.5:0.907, 7:0.892, 6.5:0.878, 6:0.864},
        2: {10:0.955, 9.5:0.939, 9:0.922, 8.5:0.907, 8:0.892, 7.5:0.878, 7:0.864, 6.5:0.85, 6:0.837},
        3: {10:0.922, 9.5:0.907, 9:0.892, 8.5:0.878, 8:0.864, 7.5:0.85, 7:0.837, 6.5:0.824, 6:0.811},
        4: {10:0.892, 9.5:0.878, 9:0.864, 8.5:0.85, 8:0.837, 7.5:0.824, 7:0.811, 6.5:0.799, 6:0.788},
        5: {10:0.864, 9.5:0.85, 9:0.837, 8.5:0.824, 8:0.811, 7.5:0.799, 7:0.788, 6.5:0.776, 6:0.766},
        6: {10:0.837, 9.5:0.824, 9:0.811, 8.5:0.799, 7.5:0.776, 7:0.766, 6.5:0.755, 6:0.744}
    };

    let activeTab = "";
    let allTabNames = []; 
    let fullProgramCache = null; 
    let charts = {}; 

    // GLOBAL CHART DEFAULTS
    Chart.defaults.interaction.mode = 'index';
    Chart.defaults.interaction.intersect = false;
    Chart.defaults.plugins.tooltip.enabled = true;

    window.onload = () => {
        initSidebar();
        fetchTabsAndInit();
        // restore sidebar preference (hidden by default)
        const open = localStorage.getItem('sidebar_open') === 'true';
        if (open) document.querySelector('.main-grid').classList.add('sidebar-open');
    };

    // Toggle settings sidebar visibility, persist preference
    function toggleSettings() {
        const mg = document.querySelector('.main-grid');
        if (!mg) return;
        const sv = document.getElementById('settingsView');
        const sc = document.getElementById('settingsContainer');
        const sidebar = document.querySelector('.sidebar-wrapper');
        if (!sv || !sc || !sidebar) {
            // fallback to previous behavior
            const open = mg.classList.toggle('sidebar-open');
            localStorage.setItem('sidebar_open', open ? 'true' : 'false');
            return;
        }

        if (sv.style.display === 'block') {
            closeSettingsView();
            return;
        }

        // move sidebar into the settings container
        sc.appendChild(sidebar);

        // remember which main view was visible so we can restore it
        const wd = document.getElementById('workoutDisplay');
        const gv = document.getElementById('graphView');
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        window._prevView = (gv && gv.style.display !== 'none') ? 'graph' : 'workout';

        // hide main workout/graph areas and top chrome
        if (wd) wd.style.display = 'none';
        if (gv) gv.style.display = 'none';
        if (nav) nav.style.display = 'none';
        if (weeks) weeks.style.display = 'none';

        // prevent body scroll behind the settings overlay
        document.body.style.overflow = 'hidden';
        sv.style.display = 'block';
    }

    function closeSettingsView() {
        const sv = document.getElementById('settingsView');
        const sidebar = document.querySelector('.sidebar-wrapper');
        const mg = document.querySelector('.main-grid');
        const workout = document.getElementById('workoutDisplay');
        if (!sv || !sidebar || !mg || !workout) return;
        // move sidebar back to the start of the main grid
        mg.insertBefore(sidebar, workout);
        sv.style.display = 'none';

        // restore previously visible view (graph or workout)
        const gv = document.getElementById('graphView');
        if (window._prevView === 'graph' && gv) {
            gv.style.display = 'block';
            if (workout) workout.style.display = 'none';
        } else {
            if (workout) workout.style.display = 'block';
            if (gv) gv.style.display = 'none';
        }

        // restore top chrome
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        if (nav) nav.style.display = '';
        if (weeks) weeks.style.display = '';
        document.body.style.overflow = '';
    }

    function initSidebar() {
        const cont = document.getElementById('statsInputs');
        ['Squat', 'Bench Press', 'Deadlift'].forEach(l => {
                const val = localStorage.getItem('1rm_' + l) || 100;
                cont.innerHTML += `<div style="margin-bottom:10px; display:flex; align-items:center; justify-content:space-between; gap:8px"><div style="display:flex; flex-direction:column;">
                    <label style="font-size:0.7rem; color:var(--text-muted); margin-bottom:6px">${l}</label>
                    <div style="font-size:0.75rem; color:var(--text-muted)">1RM</div>
                </div>
                <input type="number" class="actual-input max-input" step="0.5" value="${val}" oninput="localStorage.setItem('1rm_${l}', this.value); recalculateAll(); clearGraphCache();"></div>`;
            });
    // initialize preferences UI state
    const roundStep = localStorage.getItem('round_step') || '2.5';
        const theme = localStorage.getItem('theme') || 'default';
        const roundMode = localStorage.getItem('round_mode') || 'nearest';
        // default clips preference (persisted so modal toggle remembers state)
        if (localStorage.getItem('plates_clips') === null) localStorage.setItem('plates_clips', 'false');
        setTimeout(() => {
            const rs = document.getElementById('roundStep');
            if (rs) rs.value = roundStep;
            const ts = document.getElementById('themeSelect');
            if (ts) ts.value = theme;
            const rm = document.getElementById('roundingMode');
            if (rm) rm.value = roundMode;
            applyTheme(theme);
        }, 30);
    }

    function clearGraphCache() { fullProgramCache = null; }

    // ------------------ Preferences helpers ------------------
    function setRoundingStep(v) { localStorage.setItem('round_step', v); recalculateAll(); }
    function setRoundingMode(v) { localStorage.setItem('round_mode', v); recalculateAll(); }
    function setTheme(v) { localStorage.setItem('theme', v); applyTheme(v); }
    function applyTheme(name) {
        document.body.classList.remove('theme-light','theme-solar');
        if (name === 'light') document.body.classList.add('theme-light');
        else if (name === 'solar') document.body.classList.add('theme-solar');
    }

    function formatWeight(kg) {
        if (kg === null || kg === undefined || isNaN(kg)) return '';
        // return numeric display only (no unit suffix)
        // Show extra precision when needed (e.g. .75 instead of .8).
        // Determine desired decimals from the configured rounding step and the value itself.
        const rawStep = localStorage.getItem('round_step') || '0.5';
        // count decimals in step (e.g. 1.25 -> 2 decimals)
        let stepDecimals = 0;
        if (rawStep === 'none') {
            stepDecimals = 3; // allow finer display when no rounding selected
        } else {
            try {
                const s = String(rawStep);
                if (s.indexOf('.') >= 0) stepDecimals = s.split('.')[1].length;
            } catch (e) { stepDecimals = 0; }
        }

        // check whether 2-decimal precision materially differs from 1-decimal precision
        const rounded1 = Math.round(kg * 10) / 10;
        const rounded2 = Math.round(kg * 100) / 100;

        let decimals = 0;
        if (Math.abs(kg - Math.round(kg)) < 1e-9) decimals = 0; // integer
        else if (Math.abs(rounded2 - rounded1) > 1e-9) decimals = Math.max(2, stepDecimals);
        else decimals = Math.max(1, stepDecimals);

        // cap to sensible max (avoid weird floating artifacts)
        decimals = Math.min(decimals, 3);

        let out = kg.toFixed(decimals);
        // trim unnecessary trailing zeros and optional trailing dot
        out = out.replace(/(?:\.0+|(?<=\.\d+)0+)$/, '').replace(/\.$/, '');
        return out;
    }

    async function fetchTabsAndInit() {
        if (!API_KEY || API_KEY.includes("PASTE")) {
            document.getElementById('workoutDisplay').innerHTML = '<div class="card" style="color:var(--danger)">Error: You need to add a Google API Key.</div>';
            return;
        }

        try {
            const response = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}?key=${API_KEY}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error.message);

            const tabs = data.sheets.map(s => s.properties.title);
            allTabNames = tabs; 
            
            const nav = document.getElementById('navWeeks');
            nav.innerHTML = "";
            tabs.forEach(name => {
                const btn = document.createElement('button'); 
                btn.className = 'week-btn'; 
                btn.innerText = name;
                btn.onclick = () => loadTab(name); 
                nav.appendChild(btn);
            });

            if(tabs.length > 0) loadTab(tabs[0]);
        } catch (e) {
            document.getElementById('workoutDisplay').innerHTML = `<div class="card" style="color:var(--danger)">API Error: ${e.message}</div>`;
        }
    }

    // --- STANDARD WORKOUT LOADING ---
    function loadTab(tabName) {
        activeTab = tabName;
        document.getElementById('workoutDisplay').style.display = 'block';
        document.getElementById('graphView').style.display = 'none';
        
        document.querySelectorAll('.week-btn').forEach(b => b.classList.toggle('active', b.innerText === tabName));
        document.getElementById('workoutDisplay').innerHTML = '<div class="card" style="text-align:center"><div class="loader"></div><p>Fetching ' + tabName + '...</p></div>';
        
        const old = document.getElementById('sheetScript');
        if (old) old.remove();

        const timestamp = Date.now();
        const callbackName = 'cb_' + timestamp;

        window[callbackName] = (json) => {
            processSheet(json.table.rows);
            delete window[callbackName];
        };

        const script = document.createElement('script');
        script.id = 'sheetScript';
        script.src = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=responseHandler:${callbackName}&sheet=${encodeURIComponent(tabName)}&headers=0&t=${timestamp}`;
        document.body.appendChild(script);
    }

    function processSheet(rows) {
        const display = document.getElementById('workoutDisplay');
        display.innerHTML = '';
        let currentSection = null; let tbody = null;

        rows.forEach((r, idx) => {
            const v = (i) => (r.c && r.c[i] && r.c[i].v !== null) ? String(r.c[i].v).trim() : "";
            const name = v(0), setsStr = v(1), rpeStr = v(3), note = v(4);
            const setsNum = parseInt(setsStr);

            if (name.toLowerCase() === 'exercise') return;

            if (name && (setsStr === "" || isNaN(setsNum))) {
                if (currentSection) display.appendChild(currentSection);
                currentSection = document.createElement('div');
                currentSection.className = 'workout-section collapsed';
                currentSection.innerHTML = `
                    <div class="day-header">
                        <div class="header-content" onclick="toggleSection(this)">
                            <span class="arrow">â–¼</span>
                            <span>${name}</span>
                        </div>
                        <div class="progress-wrapper">
                            <div class="progress-container"><div class="progress-bar"></div></div>
                            <span class="progress-label">0%</span>
                        </div>
                        <span class="check-all-btn" role="button" tabindex="0" onclick="toggleAllChecks(this)">Check All</span>
                    </div>
                    <div class="content">
                        <table><thead><tr><th style="width:30px"></th><th>Exercise</th><th>Target</th><th>Act.</th></tr></thead><tbody></tbody></table>
                        <button class="btn-finish" onclick="finishWorkout('${name}', this)">Finish Workout</button>
                    </div>`;
                tbody = currentSection.querySelector('tbody');
                return;
            }

            if (!tbody) return;

            const isRamp = note.toLowerCase().includes('ramp') || note.toLowerCase().includes('warmup');
            const id = `${activeTab}_${idx}`;

            if (isRamp && setsNum > 1) {
                for (let i = 1; i <= setsNum; i++) {
                    const label = (i === setsNum) ? "Top Set" : `Ramp ${i}`;
                    const dec = (setsNum - i) * 5;
                    const css = (i === 1) ? "ramp-row" : (i === setsNum) ? "ramp-last-row" : "ramp-row";
                    tbody.appendChild(createRow(name, 1, parseInt(v(2)), parseFloat(rpeStr), label, `${id}_r${i}`, dec, css));
                }
            } else if (rpeStr.includes('%') || rpeStr.startsWith('-')) {
                // parse numeric portion, normalize fractional values (0.075 -> 7.5), round for display
                let drop = Math.abs(parseFloat(rpeStr.replace(/[^0-9.-]/g, ''))) || 10;
                if (drop > 0 && drop <= 1) drop = drop * 100; // handle fractional percent values
                drop = Math.round(drop * 10) / 10; // one decimal precision
                tbody.appendChild(createBackoffRow(name, setsStr, parseInt(v(2)), drop, id));
            } else {
                tbody.appendChild(createRow(name, setsStr, parseInt(v(2)), parseFloat(rpeStr), note, id));
            }
        });
    if (currentSection) display.appendChild(currentSection);
    recalculateAll();
    document.querySelectorAll('.workout-section').forEach(sec => updateSectionProgress(sec));
    // wire inputs and keyboard handlers once rows are present
    setTimeout(() => { attachInputHandlers(); }, 50);
    }

    function createRow(name, sets, reps, rpe, note, id, dec = 0, css = "") {
        const tr = document.createElement('tr'); tr.className = `main-row ${css}`;
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        if (checks[id]) tr.classList.add('completed');
        const pct = (RPE_CHART[reps] && RPE_CHART[reps][rpe]) ? RPE_CHART[reps][rpe] : 0;
        tr.innerHTML = `
            <td><div class="check-circle ${checks[id]?'checked':''}" data-id="${id}" tabindex="0" onclick="toggleCheck(this)" onkeydown="if(event.key===' '||event.key==='Enter'){ event.preventDefault(); toggleCheck(this);}"></div></td>
            <td><div style="font-weight:bold">${name}</div><div style="font-size:0.75rem; color:var(--text-muted)">${note}</div></td>
            <td><div style="font-size:0.8rem">${sets}x${reps} @${rpe || 'N/A'}</div><div class="load-cell" data-ex="${name}" data-pct="${pct}" data-dec="${dec}" onclick="showPlates(this.innerText)">-</div></td>
            <td><input type="number" class="actual-input" data-id="${id}" placeholder=""></td>
        `;
        return tr;
    }

    function createBackoffRow(name, sets, reps, drop, id) {
        const tr = document.createElement('tr'); tr.className = 'backoff-row';
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        if (checks[id]) tr.classList.add('completed');
        // display-friendly percent (remove trailing .0)
        const dropDisp = (Math.round(drop * 10) / 10).toString().replace(/\.0$/, '');
        tr.innerHTML = `
            <td><div class="check-circle ${checks[id]?'checked':''}" data-id="${id}" tabindex="0" onclick="toggleCheck(this)" onkeydown="if(event.key===' '||event.key==='Enter'){ event.preventDefault(); toggleCheck(this);}"></div></td>
            <td><div style="font-weight:bold">${name}</div><div style="font-size:0.75rem; color:var(--text-muted)">Backoff (-${dropDisp}%)</div></td>
            <td><div style="font-size:0.8rem">${sets}x${reps}</div><div class="load-cell backoff-calc" data-ex="${name}" data-drop="${drop}" onclick="showPlates(this.innerText)">-</div></td>
            <td><input type="number" class="actual-input" data-id="${id}" placeholder=""></td>
        `;
        return tr;
    }

    function recalculateAll() {
        const mode = document.getElementById('roundingMode').value;
        document.querySelectorAll('.load-cell:not(.backoff-calc)').forEach(cell => {
            const ex = cell.dataset.ex.toLowerCase(); const pct = parseFloat(cell.dataset.pct); const dec = parseFloat(cell.dataset.dec);
            let lift = null;
            if (ex.includes('squat')) lift = 'Squat'; 
            else if (ex.includes('bench')) lift = 'Bench Press'; 
            else if (ex.includes('deadlift')) lift = 'Deadlift';
                if (lift && pct > 0) {
                const max = parseFloat(localStorage.getItem('1rm_' + lift));
                let weight = (max * pct) - dec;
                const stepStr = localStorage.getItem('round_step') || '2.5';
                if (stepStr === 'none') {
                    // no rounding requested - keep precise value
                } else {
                    const step = parseFloat(stepStr) || 2.5;
                    if (mode === 'up') weight = Math.ceil(weight / step) * step;
                    else if (mode === 'down') weight = Math.floor(weight / step) * step;
                    else weight = Math.round(weight / step) * step;
                }
                cell.innerText = formatWeight(weight);
                cell.closest('tr').setAttribute('data-last-wt', weight);
            }
        });
        document.querySelectorAll('.backoff-calc').forEach(cell => {
            const tr = cell.closest('tr');
            let prev = tr.previousElementSibling;
            while(prev && prev.classList.contains('backoff-row')) prev = prev.previousElementSibling;
            const base = prev ? parseFloat(prev.getAttribute('data-last-wt')) : 0;
            if (base) {
                let weight = base * (1 - parseFloat(cell.dataset.drop)/100);
                const stepStr = localStorage.getItem('round_step') || '2.5';
                if (stepStr === 'none') {
                    // keep precise backoff value
                } else {
                    const step = parseFloat(stepStr) || 2.5;
                    weight = Math.round(weight / step) * step;
                }
                cell.innerText = formatWeight(weight);
            }
        });
    }

    function toggleSection(headerContent) { headerContent.closest('.workout-section').classList.toggle('collapsed'); }
    function updateSectionProgress(section) {
        const total = section.querySelectorAll('.check-circle').length;
        const checked = section.querySelectorAll('.check-circle.checked').length;
        const percentage = total === 0 ? 0 : Math.round((checked / total) * 100);
        const bar = section.querySelector('.progress-bar');
        const txt = section.querySelector('.progress-label');
        if(bar && txt) {
            bar.style.width = percentage + "%";
            txt.innerText = percentage + "%";
            if (percentage <= 30) bar.style.backgroundColor = "var(--prog-low)";
            else if (percentage <= 70) bar.style.backgroundColor = "var(--prog-mid)";
            else bar.style.backgroundColor = "var(--prog-high)";
        }
    }
    function toggleCheck(el) {
        const id = el.dataset.id;
        const checks = JSON.parse(localStorage.getItem('checks') || '{}');
        const tr = el.closest('tr');
        if (el.classList.contains('checked')) { delete checks[id]; el.classList.remove('checked'); tr.classList.remove('completed'); } 
        else { checks[id] = true; el.classList.add('checked'); tr.classList.add('completed'); }
        localStorage.setItem('checks', JSON.stringify(checks));
        updateSectionProgress(tr.closest('.workout-section'));
    }
    function toggleAllChecks(btn) {
        const section = btn.closest('.workout-section');
        const circles = section.querySelectorAll('.check-circle');
        const allChecked = Array.from(circles).every(c => c.classList.contains('checked'));
        circles.forEach(c => { if (allChecked) { if(c.classList.contains('checked')) toggleCheck(c); } else { if(!c.classList.contains('checked')) toggleCheck(c); }});
        updateSectionProgress(section);
    }
    function showPlates(txt) {
        const wt = parseFloat(txt);
        if (isNaN(wt)) return;
        // treat bar as 20kg and optionally account for clips (assumed 0.5kg total when enabled)
        const barWeight = 20;
    const clipsOn = localStorage.getItem('plates_clips') === 'true';
        // display numeric title without unit suffix
        document.getElementById('plateWeightTitle').innerText = formatWeight(wt);
        const vis = document.getElementById('plateVisuals');
    // build visuals: bar shaft (clip rendered as clip-plate instead)
    vis.innerHTML = '';
    vis.innerHTML += '<div class="bar-shaft"></div>';

        // compute per-side plate mass (remaining after bar and clips)
        const clipPerSide = clipsOn ? 2.5 : 0; // each clip treated like a 2.5kg plate
        let side = (wt - barWeight - (clipPerSide * 2)) / 2;
        // supported IPF plates (kg) including fractional small plates
        const plates = [{w:25,c:'p-25'},{w:20,c:'p-20'},{w:15,c:'p-15'},{w:10,c:'p-10'},{w:5,c:'p-5'},{w:2.5,c:'p-2-5'},{w:1.25,c:'p-1-25'},{w:0.5,c:'p-0-5'}];
        // append plates (largest to smallest) while side allows
        plates.forEach(p => { while (side + 0.0001 >= p.w) { vis.innerHTML += `<div class="plate ${p.c}">${p.w}</div>`; side -= p.w; side = Math.round(side*100)/100; }});

        // if clips enabled, render a special clip-plate on the outermost/right side
        if (clipsOn) {
            vis.innerHTML += `<div class="plate clip-plate">2.5</div>`;
        }

        // update clips button label when modal is rendered
        const clipBtn = document.getElementById('clipsToggleBtn');
        if (clipBtn) clipBtn.innerText = clipsOn ? 'Clips: On' : 'Clips: Off';
        document.getElementById('plateModal').style.display = 'flex';
    }

    function toggleClips() {
        const cur = localStorage.getItem('plates_clips') === 'true';
        localStorage.setItem('plates_clips', cur ? 'false' : 'true');
        // re-render modal visuals for the currently displayed weight
        const title = document.getElementById('plateWeightTitle');
        const wt = parseFloat(title ? title.innerText : 0);
        showPlates(wt);
    }
    function resetChecks() { if (confirm("Clear checks?")) { localStorage.removeItem('checks'); location.reload(); }}
    function showHistory() {
    const logs = JSON.parse(localStorage.getItem('workout_history') || '[]');
    document.getElementById('historyLogs').innerHTML = logs.length ? logs.map(l => `<div class="card"><h4>${l.date} - ${l.day}</h4>${l.sets.map(s => `<div>${s.ex}: A:${s.actual} / T:${s.target}</div>`).join('')}</div>`).join('') : "Empty";
        document.getElementById('historyModal').style.display = 'flex';
    }
    function finishWorkout(day, btn) {
        const sets = [];
        btn.closest('.workout-section').querySelectorAll('tr').forEach(tr => {
                if (tr.querySelector('.check-circle.checked')) {
                const exName = tr.cells[1].innerText.split('\n')[0];
                const targetText = tr.querySelector('.load-cell').innerText;
                const actualVal = tr.querySelector('.actual-input').value;
                sets.push({ ex: exName, target: targetText, actual: actualVal || targetText });
            }
        });
        if (!sets.length) return alert("Check sets.");
        const hist = JSON.parse(localStorage.getItem('workout_history') || '[]');
        hist.unshift({ date: new Date().toLocaleDateString(), day, sets });
        localStorage.setItem('workout_history', JSON.stringify(hist));
        alert("Workout Saved!");
    }

    // =============================
    // Quick-win helpers: autosave, CSV export, keyboard shortcuts, expand/collapse, modal focus
    // =============================
    function attachInputHandlers() {
        // restore any saved inputs for this tab
        restoreAutosave();

        // delegate input events
        document.querySelectorAll('.actual-input').forEach(inp => {
            inp.removeEventListener('input', saveActualInput);
            inp.addEventListener('input', saveActualInput);
        });

        // ensure check-circles are keyboard friendly (already have tabindex) and add focus styling
        document.querySelectorAll('.check-circle').forEach(c => {
            c.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); toggleCheck(c); }
            });
        });
        // make Check All controls keyboard-activatable
        document.querySelectorAll('.check-all-btn').forEach(b => {
            b.addEventListener('keydown', (e) => {
                if (e.key === ' ' || e.key === 'Enter') { e.preventDefault(); toggleAllChecks(b); }
            });
        });
        // update expand toggle button label to reflect current state
        updateExpandToggleText();
    }

    function saveActualInput(e) {
        const inp = e.target;
        const id = inp.dataset.id || (inp.closest('tr') && inp.closest('tr').getAttribute('data-id'));
        if (!id) return;
        const key = 'autosave_' + activeTab;
        const obj = JSON.parse(localStorage.getItem(key) || '{}');
        obj[id] = inp.value;
        localStorage.setItem(key, JSON.stringify(obj));
    }

    function restoreAutosave() {
        const key = 'autosave_' + activeTab;
        const obj = JSON.parse(localStorage.getItem(key) || '{}');
        if (!obj) return;
        document.querySelectorAll('.actual-input').forEach(inp => {
            const id = inp.dataset.id;
            if (id && obj[id] !== undefined) inp.value = obj[id];
        });
    }

    function exportHistoryCSV() {
        const hist = JSON.parse(localStorage.getItem('workout_history') || '[]');
        if (!hist.length) return alert('No history to export');
        const lines = [];
        lines.push(['date','day','exercise','target','actual'].join(','));
        hist.forEach(h => {
            h.sets.forEach(s => {
                const row = [h.date, '"' + h.day.replace(/"/g,'""') + '"', '"' + String(s.ex).replace(/"/g,'""') + '"', String(s.target), String(s.actual)];
                lines.push(row.join(','));
            });
        });
        const csv = lines.join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'workout_history.csv';
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    }

    // ---------- CSV IMPORT FOR HISTORY ----------
    function triggerImportHistory() {
        const inp = document.getElementById('importHistoryInput');
        if (!inp) return alert('Import input not found');
        inp.value = null; // reset so same file can be reselected
        inp.click();
    }

    function handleHistoryFileChange(e) {
        const f = e.target.files && e.target.files[0];
        if (!f) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            try {
                const text = ev.target.result;
                importHistoryCSV(text);
            } catch (err) {
                alert('Failed to import CSV: ' + err.message);
            }
        };
        reader.readAsText(f);
    }

    function parseCSV(text) {
        const rows = [];
        let cur = '';
        let row = [];
        let inQuotes = false;
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i+1] === '"') { cur += '"'; i++; }
                    else { inQuotes = false; }
                } else {
                    cur += ch;
                }
            } else {
                if (ch === '"') { inQuotes = true; }
                else if (ch === ',') { row.push(cur); cur = ''; }
                else if (ch === '\r') { /* ignore */ }
                else if (ch === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; }
                else { cur += ch; }
            }
        }
        // trailing
        if (inQuotes) throw new Error('Malformed CSV: unmatched quote');
        if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
        return rows;
    }

    function importHistoryCSV(text) {
        const rows = parseCSV(text).map(r => r.map(c => c.trim()));
        if (!rows.length) return alert('CSV empty');

        // detect header
        const header = rows[0].map(h => h.toLowerCase());
        let dataRows = rows;
        let hasHeader = false;
        if (header.includes('date') || header.includes('exercise') || header.includes('actual')) {
            hasHeader = true;
            dataRows = rows.slice(1);
        }

        // determine column indexes (fall back to expected order)
        const cols = hasHeader ? header : ['date','day','exercise','target','actual'];
        const idx = {
            date: cols.indexOf('date'),
            day: cols.indexOf('day'),
            ex: cols.indexOf('exercise'),
            target: cols.indexOf('target'),
            actual: cols.indexOf('actual')
        };
        // if header didn't include 'day' but has 5 columns in order, assume positions
        if (!hasHeader && dataRows[0] && dataRows[0].length >= 5) {
            idx.date = 0; idx.day = 1; idx.ex = 2; idx.target = 3; idx.actual = 4;
        }

        const sessionsMap = {};
        let importedCount = 0;
        dataRows.forEach(r => {
            if (!r || r.length === 0) return;
            const date = (r[idx.date] || '').trim();
            const day = (idx.day >= 0 ? (r[idx.day] || '') : '') .trim();
            const ex = (r[idx.ex] || '').trim();
            const target = (idx.target >= 0 ? (r[idx.target] || '') : '').trim();
            const actual = (idx.actual >= 0 ? (r[idx.actual] || '') : '').trim();
            if (!ex) return; // skip empty exercise rows
            const key = (date || '') + '|' + (day || '');
            if (!sessionsMap[key]) sessionsMap[key] = { date: date || new Date().toLocaleDateString(), day: day || '', sets: [] };
            sessionsMap[key].sets.push({ ex: ex, target: target, actual: actual });
            importedCount++;
        });

        const importedSessions = Object.values(sessionsMap);
        if (!importedSessions.length) return alert('No valid rows found in CSV');

        const existing = JSON.parse(localStorage.getItem('workout_history') || '[]');
        const append = confirm(`Imported ${importedCount} rows across ${importedSessions.length} sessions. Click OK to append to existing history, Cancel to replace it.`);
        let out = [];
        if (append) out = importedSessions.concat(existing);
        else out = importedSessions;

        localStorage.setItem('workout_history', JSON.stringify(out));
        alert('Import complete: ' + importedSessions.length + ' sessions');
        // refresh history view
        showHistory();
    }

    function expandAllSections() { document.querySelectorAll('.workout-section').forEach(s => s.classList.remove('collapsed')); }
    function collapseAllSections() { document.querySelectorAll('.workout-section').forEach(s => s.classList.add('collapsed')); }

    function toggleExpandToggle() {
        const anyCollapsed = document.querySelectorAll('.workout-section.collapsed').length > 0;
        if (anyCollapsed) {
            expandAllSections();
            document.getElementById('expandToggleBtn').innerText = 'Collapse All';
        } else {
            collapseAllSections();
            document.getElementById('expandToggleBtn').innerText = 'Expand All';
        }
    }

    function updateExpandToggleText() {
        const btn = document.getElementById('expandToggleBtn');
        if (!btn) return;
        const anyCollapsed = document.querySelectorAll('.workout-section.collapsed').length > 0;
        btn.innerText = anyCollapsed ? 'Expand All' : 'Collapse All';
    }

    function openModal(id) {
        const m = document.getElementById(id);
        if (!m) return;
        m.style.display = 'flex';
        m.setAttribute('aria-hidden', 'false');
        const content = m.querySelector('.modal-content');
        if (content) content.focus();
        trapModalFocus(m);
    }

    function closeModal(id) {
        const m = document.getElementById(id);
        if (!m) return;
        m.style.display = 'none';
        m.setAttribute('aria-hidden', 'true');
        untrapModalFocus(m);
    }

    let _modalKeyHandler = null;
    function trapModalFocus(modal) {
        _modalKeyHandler = function(e) {
            if (e.key === 'Escape') { closeModal(modal.id); }
            if (e.key === 'Tab') {
                const focusables = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (!focusables.length) { e.preventDefault(); return; }
                const first = focusables[0];
                const last = focusables[focusables.length-1];
                if (e.shiftKey && document.activeElement === first) { e.preventDefault(); last.focus(); }
                else if (!e.shiftKey && document.activeElement === last) { e.preventDefault(); first.focus(); }
            }
        };
        document.addEventListener('keydown', _modalKeyHandler);
    }

    function untrapModalFocus(modal) { if (_modalKeyHandler) document.removeEventListener('keydown', _modalKeyHandler); _modalKeyHandler = null; }

    // Wire showPlates/showHistory to open modals with new helpers
    const _origShowPlates = showPlates;
    showPlates = function(txt) { _origShowPlates(txt); openModal('plateModal'); };

    const _origShowHistory = showHistory;
    showHistory = function() { 
        _origShowHistory(); 
        openModal('historyModal'); 
        // ensure history modal uses the fullscreen modal styles (matches Graphs/Settings)
        const _histModal = document.getElementById('historyModal');
        if (_histModal) _histModal.classList.add('fullscreen');
        // behave like a full-page overlay: hide top chrome and prevent body scroll
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        const wd = document.getElementById('workoutDisplay');
        const gv = document.getElementById('graphView');
        window._prevView = (gv && gv.style.display !== 'none') ? 'graph' : 'workout';
        if (wd) wd.style.display = 'none';
        if (gv) gv.style.display = 'none';
        if (nav) nav.style.display = 'none';
        if (weeks) weeks.style.display = 'none';
        document.body.style.overflow = 'hidden';
    };

    // Global shortcuts (g = graphs toggle, h = history, / = focus search (if exists))
    document.addEventListener('keydown', (e) => {
        if (e.target && (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable)) return;
        if (e.key === 'g') { e.preventDefault(); toggleGraphView(); }
        if (e.key === 'h') { e.preventDefault(); showHistory(); }
    });

    function closeHistoryView() {
        // remove fullscreen flag then close
        const _histModalClose = document.getElementById('historyModal');
        if (_histModalClose) _histModalClose.classList.remove('fullscreen');
        closeModal('historyModal');
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        const wd = document.getElementById('workoutDisplay');
        const gv = document.getElementById('graphView');
        // restore previous view
        if (window._prevView === 'graph' && gv) {
            gv.style.display = 'block';
            gv.classList.add('overlay');
            if (wd) wd.style.display = 'none';
        } else {
            if (wd) wd.style.display = 'block';
            if (gv) gv.style.display = 'none';
            gv.classList.remove('overlay');
        }
        if (nav) nav.style.display = '';
        if (weeks) weeks.style.display = '';
        document.body.style.overflow = '';
    }

    function closeGraphView() {
        const gDisplay = document.getElementById('graphView');
        const wDisplay = document.getElementById('workoutDisplay');
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        if (!gDisplay) return;
        // hide overlay
        gDisplay.classList.remove('overlay');
        gDisplay.style.display = 'none';
        // restore previous view
        if (window._prevView === 'graph') {
            // if graph was previous, nothing to show
        }
        if (wDisplay) wDisplay.style.display = 'block';
        if (nav) nav.style.display = '';
        if (weeks) weeks.style.display = '';
        document.body.style.overflow = '';
    }

    // After rendering new tab content, call attachInputHandlers
    const _origLoadTab = loadTab;
    loadTab = function(tabName) {
        _origLoadTab(tabName);
        // when sheet script inserts rows it will call processSheet -> recalculateAll -> updateSectionProgress
        // schedule a small delay to attach inputs after rows are built
        setTimeout(() => { attachInputHandlers(); }, 600);
    };

    // ==========================================
    // ðŸ“Š NEW COMBO GRAPH LOGIC (3 CHARTS)
    // ==========================================
    function toggleGraphView() {
        const wDisplay = document.getElementById('workoutDisplay');
        const gDisplay = document.getElementById('graphView');
        const nav = document.querySelector('.navbar');
        const weeks = document.getElementById('navWeeks');
        if (!gDisplay) return;

        if (gDisplay.classList.contains('overlay')) {
            // closing overlay
            gDisplay.classList.remove('overlay');
            gDisplay.style.display = 'none';
            if (window._prevView === 'graph') {
                // if graph was previous, keep it hidden
            }
            if (wDisplay) wDisplay.style.display = 'block';
            if (nav) nav.style.display = '';
            if (weeks) weeks.style.display = '';
            document.body.style.overflow = '';
        } else {
            // opening overlay
            window._prevView = (gDisplay.style.display !== 'none') ? 'graph' : 'workout';
            if (wDisplay) wDisplay.style.display = 'none';
            if (gDisplay) gDisplay.style.display = 'block';
            gDisplay.classList.add('overlay');
            if (nav) nav.style.display = 'none';
            if (weeks) weeks.style.display = 'none';
            document.body.style.overflow = 'hidden';
            loadFullProgramData();
        }
    }

    async function loadFullProgramData() {
        if (fullProgramCache) { renderGraphs(fullProgramCache); return; }
        if (!allTabNames.length) return;

        document.getElementById('graphLoader').style.display = 'block';

        const tabsToFetch = allTabNames.slice(0, 16); 
        const ranges = tabsToFetch.map(t => `ranges=${encodeURIComponent(t)}!A:E`).join('&');
        
        try {
            const res = await fetch(`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?${ranges}&key=${API_KEY}`);
            const json = await res.json();
            
            if (!json.valueRanges) throw new Error("No data returned");

            const results = {}; 
            
            json.valueRanges.forEach(rangeObj => {
                const fullTitle = rangeObj.range; 
                const tabName = fullTitle.split('!')[0].replace(/'/g, "");
                
                const rows = rangeObj.values;
                if(!rows) return;

                let maxS = 0, maxB = 0, maxD = 0;
                let volS = 0, volB = 0, volD = 0;
                
                rows.forEach(r => {
                    if(!r[0]) return;
                    const name = r[0].toLowerCase();
                    const sets = parseInt(r[1]) || 0;
                    const reps = parseInt(r[2]) || 0;
                    const rpeStr = String(r[3]).trim();
                    
                    if (name.includes('exercise')) return;
                    
                    let pct = 0;
                    let rpeVal = parseFloat(rpeStr.replace(/[^0-9.]/g, ''));
                    if(rpeStr.includes('%') || rpeVal > 10) pct = rpeVal / 100;
                    else if(RPE_CHART[reps] && RPE_CHART[reps][rpeVal]) pct = RPE_CHART[reps][rpeVal];
                    if(isNaN(pct)) pct = 0;
                    
                    if (pct > 0) {
                        let w = 0;
                        if (name.includes('squat')) {
                            w = parseFloat(localStorage.getItem('1rm_Squat')||100) * pct;
                            if(w > maxS) maxS = w;
                            volS += (sets * reps * w);
                        } else if (name.includes('bench')) {
                            w = parseFloat(localStorage.getItem('1rm_Bench Press')||100) * pct;
                            if(w > maxB) maxB = w;
                            volB += (sets * reps * w);
                        } 
                        else if (name.includes('deadlift') || name.match(/\bdl\b/) || name.includes('pull')) {
                            w = parseFloat(localStorage.getItem('1rm_Deadlift')||100) * pct;
                            if(w > maxD) maxD = w;
                            volD += (sets * reps * w);
                        }
                    }
                });

                const stepStr = localStorage.getItem('round_step') || '0.5';
                const roundStep = parseFloat(stepStr);
                results[tabName] = { 
                    s: maxS > 0 ? (stepStr === 'none' ? maxS : Math.round(maxS/roundStep)*roundStep) : 0, 
                    b: maxB > 0 ? (stepStr === 'none' ? maxB : Math.round(maxB/roundStep)*roundStep) : 0, 
                    d: maxD > 0 ? (stepStr === 'none' ? maxD : Math.round(maxD/roundStep)*roundStep) : 0,
                    volS: volS > 0 ? Math.round(volS) : 0,
                    volB: volB > 0 ? Math.round(volB) : 0,
                    volD: volD > 0 ? Math.round(volD) : 0
                };
            });

            fullProgramCache = { tabs: tabsToFetch, data: results };
            renderGraphs(fullProgramCache);
            document.getElementById('graphLoader').style.display = 'none';

        } catch(e) {
            console.error(e);
            alert("Could not load full program: " + e.message);
        }
    }

    function renderGraphs(programData) {
        const labels = programData.tabs; 
        
        // 1. DATA PREP (Fill Forward)
        const buildSeries = (key) => {
            const arr = [];
            labels.forEach(l => arr.push(programData.data[l] ? programData.data[l][key] : 0));
            let firstVal = 0;
            for(let i=0; i<arr.length; i++) { if(arr[i] > 0) { firstVal = arr[i]; break; } }
            let lastVal = firstVal;
            return arr.map(val => { if (val > 0) { lastVal = val; return val; } else { return lastVal; } });
        };

        const tgtS = buildSeries('s');
        const tgtB = buildSeries('b');
        const tgtD = buildSeries('d');
        const vS = buildSeries('volS');
        const vB = buildSeries('volB');
        const vD = buildSeries('volD');

        // Actuals
        const hist = JSON.parse(localStorage.getItem('workout_history') || '[]');
        const actS = new Array(labels.length).fill(null);
        const actB = new Array(labels.length).fill(null);
        const actD = new Array(labels.length).fill(null);

        hist.forEach(h => {
            const idx = labels.indexOf(h.day); 
            if (idx !== -1) {
                h.sets.forEach(s => {
                    const val = parseFloat(s.actual);
                    if (!val) return;
                    const n = s.ex.toLowerCase();
                    if (n.includes('squat') && val > (actS[idx]||0)) actS[idx] = val;
                    if (n.includes('bench') && val > (actB[idx]||0)) actB[idx] = val;
                    if (n.includes('deadlift') && val > (actD[idx]||0)) actD[idx] = val;
                });
            }
        });

        // 2. HELPER TO CREATE DUAL AXIS CHARTS
        const createDualChart = (ctxId, label, color, tgtData, actData, volData) => {
            const ctx = document.getElementById(ctxId).getContext('2d');
            if (charts[ctxId]) charts[ctxId].destroy();
            
            charts[ctxId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { 
                            label: 'Volume (Right)', 
                            data: volData, 
                            type: 'bar',
                            yAxisID: 'y1', 
                            // Use same color as the lines for the bar (and match border)
                            backgroundColor: color,
                            borderColor: color,
                            borderWidth: 1,
                            barPercentage: 0.5
                        },
                        { 
                            label: 'Target Weight (Left)', 
                            data: tgtData, 
                            borderColor: color, 
                            borderDash: [5,5], 
                            pointRadius: 4, 
                            pointHitRadius: 20, 
                            tension: 0.2, 
                            yAxisID: 'y' 
                        },
                        { 
                            label: 'Actual Weight (Left)', 
                            data: actData, 
                            borderColor: '#ffffff', // WHITE ACTUAL LINE
                            backgroundColor: '#ffffff', 
                            pointRadius: 6, 
                            pointHitRadius: 20, 
                            spanGaps: true, 
                            yAxisID: 'y' 
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { tooltip: { enabled: true, mode: 'index', intersect: false } },
                    scales: {
                        y: { 
                            type: 'linear', 
                            display: true, 
                            position: 'left', 
                            beginAtZero: true, // START AT 0
                            title: {display: true, text: 'Max Weight (kg)'},
                            grid: { color: '#334155' }
                        },
                        y1: { 
                            type: 'linear', 
                            display: true, 
                            position: 'right', 
                            beginAtZero: true,
                            title: {display: true, text: 'Volume (kg)'},
                            grid: { drawOnChartArea: false } // clean look
                        }
                    }
                }
            });
        };

        createDualChart('sqChart', 'Squat', '#ef4444', tgtS, actS, vS);
        createDualChart('bpChart', 'Bench', '#3b82f6', tgtB, actB, vB);
        createDualChart('dlChart', 'Deadlift', '#22c55e', tgtD, actD, vD);
    }
</script>
</body>
</html>
