<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart RPE Live</title>
    <style>
        :root {
            --primary: #3b82f6; --bg: #0f172a; --card-bg: #1e293b; --backoff-bg: #162032;
            --text: #f8fafc; --text-muted: #94a3b8; --border: #334155; --input-bg: #0f172a;
            --highlight: #22c55e; --danger: #ef4444;
        }

        body {
            font-family: -apple-system, system-ui, sans-serif;
            background-color: var(--bg); color: var(--text);
            padding: 1rem; max-width: 1200px; margin: 0 auto; padding-bottom: 4rem;
        }

        h1, h2, h3 { margin-top: 0; }
        .main-grid { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; align-items: start; }
        .sidebar-wrapper { position: sticky; top: 20px; align-self: start; }
        @media (max-width: 900px) { 
            .main-grid { grid-template-columns: 1fr; gap: 1rem; }
            .sidebar-wrapper { position: static; }
            #statsContainer { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
            .stat-row { margin-bottom: 0 !important; }
            .stat-label { font-size: 0.7rem !important; }
        }

        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2); }
        .navbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
        
        input[type="number"], select, input[type="text"] { background: var(--input-bg); border: 1px solid var(--border); color: white; padding: 0.5rem; width: 100%; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }

        .workout-section { margin-bottom: 2rem; background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .workout-header { background: rgba(0,0,0,0.2); padding: 1rem; border-bottom: 1px solid var(--border); font-size: 1.25rem; font-weight: 700; color: var(--primary); text-transform: capitalize; display: flex; justify-content: space-between; align-items: center; }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        th, td { padding: 0.75rem 0.5rem; text-align: left; border-bottom: 1px solid var(--border); vertical-align: middle; }
        th { font-size: 0.75rem; text-transform: uppercase; color: var(--text-muted); background: var(--card-bg); white-space: nowrap;}
        
        .main-row { background: var(--card-bg); }
        .backoff-row { background-color: var(--backoff-bg); }
        .completed { opacity: 0.4; filter: grayscale(1); }

        .load-cell { font-size: 1.2rem; font-weight: 800; color: var(--highlight); cursor: pointer; text-decoration: underline; text-decoration-style: dotted; text-decoration-color: var(--text-muted); }
        .tiny-input { width: 50px !important; padding: 0.3rem !important; text-align: center; }
        .actual-input { width: 60px !important; padding: 0.3rem !important; text-align: center; border: 1px solid var(--border); color: var(--highlight); font-weight: bold; }
        
        .check-circle { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .check-circle.checked { background: var(--highlight); border-color: var(--highlight); }
        .check-circle.checked::after { content: "âœ“"; color: white; font-weight: bold; font-size: 14px; }

        .btn { background: var(--primary); color: white; padding: 0.5rem 1rem; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-text { background: transparent; border: none; color: var(--primary); font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.7rem; margin-top: 6px; background: var(--border); }
        .btn-finish { width: 100%; padding: 1rem; font-size: 1.1rem; background: var(--highlight); margin-top: 1rem; }
        .btn-del { background: transparent; color: var(--text-muted); font-size: 1.2rem; }
        .btn-danger { background: transparent; border: 1px solid var(--danger); color: var(--danger); width: 100%; margin-top: 1rem; }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Modals & Loader */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; padding: 1rem; }
        .modal-content { background: var(--card-bg); padding: 2rem; border-radius: 12px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto; position: relative; }
        .plate-container { display: flex; align-items: center; justify-content: center; gap: 5px; margin-top: 1rem; flex-wrap: wrap;}
        .plate { height: 60px; width: 15px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 10px; color: black; font-weight: bold; }
        .plate-25 { background: #ef4444; height: 80px; } .plate-20 { background: #3b82f6; height: 75px; } .plate-15 { background: #eab308; height: 70px; } .plate-10 { background: #22c55e; height: 60px; } .plate-5 { background: #f8fafc; height: 50px; } .plate-2-5 { background: #000; height: 45px; border: 1px solid #666; color: white;} .plate-1-25 { background: #94a3b8; height: 40px; }
        .barbell { width: 10px; height: 90px; background: #94a3b8; margin: 0 10px; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="navbar">
    <h1>Smart RPE Live</h1>
    <button class="btn btn-outline" onclick="showHistory()">History</button>
</div>

<div id="loadingState">
    <div class="card" style="text-align: center; padding: 3rem;">
        <h3>Syncing with Google...</h3>
        <div class="loader"></div>
        <p style="color: var(--text-muted);">Fetching Monday, Wednesday, Thursday, Friday</p>
    </div>
</div>

<div id="errorState" class="hidden">
    <div class="card" style="text-align: center; padding: 2rem;">
        <h3 style="color: var(--danger)">Connection Failed</h3>
        <p>1. Check if the Sheet is still shared ("Anyone with link").</p>
        <p>2. Check if the tab names in the sheet match the code exactly.</p>
    </div>
</div>

<div class="main-grid hidden" id="mainInterface">
    <div class="sidebar-wrapper">
        <div class="card" style="padding: 1rem;">
            <h2 style="font-size: 1.1rem; margin-bottom: 0.5rem;">Your Maxes</h2>
            <div id="statsContainer"></div>
        </div>
    </div>
    <div id="workoutsContainer"></div>
</div>

<div id="plateModal" class="modal-overlay" onclick="closeModal('plateModal')"><div class="modal-content" onclick="event.stopPropagation()"><h2 style="text-align: center;">Load the Bar</h2><div style="text-align: center; font-size: 3rem; font-weight: 800; color: var(--highlight);" id="modalWeightDisplay">0</div><p style="text-align: center; color: var(--text-muted);">(Per Side)</p><div class="plate-container" id="plateVisuals"></div><button class="btn" style="width: 100%; margin-top: 2rem;" onclick="closeModal('plateModal')">Close</button></div></div>

<div id="historyModal" class="modal-overlay" onclick="closeModal('historyModal')">
    <div class="modal-content" onclick="event.stopPropagation()">
        <h2>Session History</h2>
        <div id="historyList"></div>
        <button class="btn btn-danger" onclick="clearHistory()">Clear All History</button>
        <button class="btn" style="width: 100%; margin-top: 10px;" onclick="closeModal('historyModal')">Close</button>
    </div>
</div>

<script>
    // =========================================================================
    // ðŸ‘‡ YOUR CONFIGURATION ðŸ‘‡
    // =========================================================================
    
    // Your specific Google Sheet ID
    const SHEET_ID = "1uM-HgPoZxD79GUFfKuISO6bBgsIgPr7OSJYp4LrWJfU"; 
    
    // Your specific Tab names
    const TABS = ["Monday", "Wednesday", "Thursday", "Friday"];

    // =========================================================================
    // =========================================================================

    const rpeChart = {
        1: {10: 1.0, 9.5: 0.978, 9: 0.955, 8.5: 0.939, 8: 0.922, 7.5: 0.907, 7: 0.892, 6.5: 0.878, 6: 0.864},
        2: {10: 0.955, 9.5: 0.939, 9: 0.922, 8.5: 0.907, 8: 0.892, 7.5: 0.878, 7: 0.864, 6.5: 0.85, 6: 0.837},
        3: {10: 0.922, 9.5: 0.907, 9: 0.892, 8.5: 0.878, 8: 0.864, 7.5: 0.85, 7: 0.837, 6.5: 0.824, 6: 0.811},
        4: {10: 0.892, 9.5: 0.878, 9: 0.864, 8.5: 0.85, 8: 0.837, 7.5: 0.824, 7: 0.811, 6.5: 0.799, 6: 0.788},
        5: {10: 0.864, 9.5: 0.85, 9: 0.837, 8.5: 0.824, 8: 0.811, 7.5: 0.799, 7: 0.788, 6.5: 0.776, 6: 0.766},
        6: {10: 0.837, 9.5: 0.824, 9: 0.811, 8.5: 0.799, 8: 0.788, 7.5: 0.776, 7: 0.766, 6.5: 0.755, 6: 0.744},
        8: {10: 0.788, 9.5: 0.776, 9: 0.766, 8.5: 0.755, 8: 0.744, 7.5: 0.734, 7: 0.724, 6.5: 0.714, 6: 0.705},
        10: {10: 0.744, 9.5: 0.734, 9: 0.724, 8.5: 0.714, 8: 0.705, 7.5: 0.696, 7: 0.687, 6.5: 0.679, 6: 0.670},
        12: {10: 0.705, 9.5: 0.696, 9: 0.687, 8.5: 0.679, 8: 0.670, 7.5: 0.662, 7: 0.654, 6.5: 0.646, 6: 0.639}
    };
    const dayMap = {'monday':1,'tuesday':2,'wednesday':3,'thursday':4,'friday':5,'saturday':6,'sunday':7};

    window.addEventListener('DOMContentLoaded', () => {
        buildStatsInputs();
        loadFromGoogle();
    });

    function loadFromGoogle() {
        // We use the Proxy + GVIZ method here. It constructs the URL using your ID and Tabs.
        const promises = TABS.map(tab => {
            const googleUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tab)}`;
            const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(googleUrl)}`;
            
            return fetch(proxyUrl)
                .then(res => {
                    if(!res.ok) throw new Error("Failed");
                    return res.text();
                })
                .then(csv => ({ title: tab, data: parseCSV(csv) }))
                .catch(err => {
                    console.error("Error loading " + tab, err);
                    return null;
                });
        });

        Promise.all(promises).then(results => {
            const valid = results.filter(r => r && r.data.length > 0);
            document.getElementById('loadingState').classList.add('hidden');
            if(valid.length === 0) {
                document.getElementById('errorState').classList.remove('hidden');
            } else {
                renderWorkouts(valid);
            }
        });
    }

    function parseCSV(text) {
        const lines = text.split('\n');
        const data = [];
        for(let i=1; i<lines.length; i++){
            let row = lines[i].trim();
            if(!row) continue;
            // Google Viz API often quotes fields. This regex handles commas inside quotes.
            const cols = row.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            const cleanCols = cols.map(c => c.replace(/^"|"$/g, '').trim());
            if(cleanCols.length < 1) continue;
            
            const exercise = cleanCols[0];
            if(!exercise) continue;

            const rawRPE = cleanCols[3] || "";
            let isBackoff = false, drop=0, rpe=0;
            if(rawRPE.includes('%') || rawRPE.startsWith('-')){
                isBackoff = true;
                drop = parseFloat(rawRPE.replace(/[^0-9.]/g, ''));
            } else { rpe = parseFloat(rawRPE); }

            data.push({
                exercise, sets: cleanCols[1] || "-", reps: parseFloat(cleanCols[2]) || 0,
                rpe, notes: cleanCols[4] || "", isBackoff, drop
            });
        }
        return data;
    }

    function renderWorkouts(valid) {
        valid.sort((a, b) => {
            const da = dayMap[a.title.toLowerCase()] || 99;
            const db = dayMap[b.title.toLowerCase()] || 99;
            return da === db ? a.title.localeCompare(b.title) : da - db;
        });

        const container = document.getElementById('workoutsContainer');
        container.innerHTML = '';
        valid.forEach((res, idx) => createWorkoutSection(res.title, res.data, container, idx));
        triggerInitialCalculation();
        document.getElementById('mainInterface').classList.remove('hidden');
    }

    // --- BUILDERS ---
    function buildStatsInputs() {
        const c = document.getElementById('statsContainer'); c.innerHTML = '';
        ['Squat','Bench Press','Deadlift'].forEach(lift => {
            const val = localStorage.getItem('1rm_'+lift) || '';
            const d = document.createElement('div');
            d.innerHTML = `<label class="stat-label">${lift}</label>
            <input type="number" value="${val}" placeholder="0" oninput="updateMax('${lift}',this.value)">`;
            c.appendChild(d);
        });
    }

    function createWorkoutSection(title, data, container, index) {
        const section = document.createElement('div');
        section.className = 'workout-section';
        
        // Added Check All button to Header
        section.innerHTML = `
            <div class="workout-header">
                <span>${title}</span>
                <button class="btn-text" onclick="toggleAllChecks(this)">Check All</button>
            </div>
        `;
        
        const table = document.createElement('table');
        table.innerHTML = `<thead><tr><th style="width:10px"></th><th>Exercise</th><th>Target</th><th>Act.</th></tr></thead><tbody></tbody>`;
        const tbody = table.querySelector('tbody');
        let lastMainRow = null;
        data.forEach(row => {
            if(row.isBackoff && lastMainRow) { createBackoffRow(tbody, lastMainRow, row); return; }
            const tr = document.createElement('tr');
            tr.className = "main-row";
            tr.setAttribute('data-exercise', row.exercise);
            tr.setAttribute('data-reps', row.reps);
            const validReps = rpeChart[row.reps];
            let rpeSelect = `<span style="color:#94a3b8">N/A</span>`;
            let pct = 0;
            if(validReps) {
                pct = validReps[row.rpe] || 0;
                const opts = Object.keys(validReps).sort((a,b)=>b-a).map(r => 
                    `<option value="${r}" ${parseFloat(r)===row.rpe?'selected':''}>@${r}</option>`
                ).join('');
                rpeSelect = `<select class="rpe-select" onchange="updateRowRPE(this)" style="width:60px">${opts}</select>`;
            }
            tr.setAttribute('data-pct', pct);
            
            // Warmup button removed
            tr.innerHTML = `<td><div class="check-circle" onclick="toggleCheck(this)"></div></td><td><div style="font-weight:bold">${row.exercise}</div><div style="font-size:0.75rem; color:var(--text-muted)">${row.notes}</div></td><td><div style="font-size:0.85rem">${row.sets} x ${row.reps} ${rpeSelect}</div><div class="load-cell" onclick="showPlateMath(this)">-</div><button class="btn btn-sm" onclick="addManualBackoff(this)">+ Backoff</button></td><td><input type="number" class="actual-input" placeholder="kg"></td>`;
            tbody.appendChild(tr);
            lastMainRow = tr;
        });
        section.appendChild(table);
        const finishBtn = document.createElement('button');
        finishBtn.className = 'btn btn-finish';
        finishBtn.innerText = "Finish Workout âœ…";
        finishBtn.onclick = () => finishWorkout(title, tbody);
        section.appendChild(finishBtn);
        container.appendChild(section);
    }

    function createBackoffRow(tbody, mainRow, rowData) {
        const tr = document.createElement('tr');
        tr.className = 'backoff-row';
        const label = rowData.exercise === mainRow.getAttribute('data-exercise') ? "Backoff" : rowData.exercise;
        const setsReps = (rowData.sets && rowData.reps) ? `${rowData.sets} x ${rowData.reps}` : "";
        tr.innerHTML = `<td><div class="check-circle" onclick="toggleCheck(this)"></div></td><td><div class="backoff-label">${label}</div></td><td><div class="drop-input-group"><span style="font-size:0.8rem; color:var(--text-muted)">Drop:</span><input type="number" class="tiny-input" value="${rowData.drop||10}" oninput="recalculateBackoff(this)">%</div><div style="font-size:0.8rem; color:var(--text-muted); margin-top:2px">${setsReps}</div><div class="load-cell backoff-load" onclick="showPlateMath(this)">-</div><button class="btn btn-del" onclick="this.closest('tr').remove()">Ã—</button></td><td><input type="number" class="actual-input" placeholder="kg"></td>`;
        let insertAfter = mainRow;
        while(insertAfter.nextElementSibling && insertAfter.nextElementSibling.classList.contains('backoff-row')) insertAfter = insertAfter.nextElementSibling;
        tbody.insertBefore(tr, insertAfter.nextSibling);
        setTimeout(() => recalculateBackoff(tr.querySelector('.tiny-input')), 50);
    }

    // --- CHECK ALL FEATURE ---
    function toggleAllChecks(btn) {
        const section = btn.closest('.workout-section');
        const circles = section.querySelectorAll('.check-circle');
        const allChecked = Array.from(circles).every(c => c.classList.contains('checked'));
        
        circles.forEach(c => {
            const tr = c.closest('tr');
            if(allChecked) {
                c.classList.remove('checked');
                tr.classList.remove('completed');
            } else {
                c.classList.add('checked');
                tr.classList.add('completed');
            }
        });
        btn.innerText = allChecked ? "Check All" : "Uncheck All";
    }

    // --- UTILS ---
    function showPlateMath(cell) {
        const weight = parseFloat(cell.innerText); if(isNaN(weight)) return;
        document.getElementById('modalWeightDisplay').innerText = weight;
        const container = document.getElementById('plateVisuals'); container.innerHTML = '';
        let perSide = (weight - 20) / 2;
        if(perSide <= 0) { container.innerHTML = "Just the bar!"; } else {
            const plates = [{w:25,c:'plate-25'},{w:20,c:'plate-20'},{w:15,c:'plate-15'},{w:10,c:'plate-10'},{w:5,c:'plate-5'},{w:2.5,c:'plate-2-5'},{w:1.25,c:'plate-1-25'}];
            container.appendChild(document.createElement('div')).className = 'barbell';
            plates.forEach(p => { while(perSide >= p.w) { const d=document.createElement('div'); d.className=`plate ${p.c}`; d.innerText=p.w; container.appendChild(d); perSide-=p.w; perSide=Math.round(perSide*100)/100; }});
        }
        document.getElementById('plateModal').style.display = 'flex';
    }
    
    function toggleCheck(el) { 
        el.classList.toggle('checked'); 
        el.closest('tr').classList.toggle('completed'); 
    }
    
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    function finishWorkout(title, tbody) {
        const sets = [];
        tbody.querySelectorAll('tr').forEach(tr => {
            if(tr.querySelector('.check-circle.checked')) {
                const ex = tr.querySelector('td:nth-child(2)').innerText.split('\n')[0].replace('ðŸ”¥','').trim();
                const actual = tr.querySelector('.actual-input').value;
                const planned = tr.querySelector('.load-cell').innerText;
                sets.push({ exercise: ex, weight: actual || planned });
            }
        });
        if(sets.length===0) return alert("No completed sets marked.");
        const history = JSON.parse(localStorage.getItem('workout_history') || '[]');
        history.unshift({ date: new Date().toLocaleDateString(), title, sets });
        localStorage.setItem('workout_history', JSON.stringify(history));
        alert("Workout Saved!");
    }

    function showHistory() {
        const h = JSON.parse(localStorage.getItem('workout_history') || '[]');
        const l = document.getElementById('historyList'); l.innerHTML = '';
        if(h.length === 0) l.innerHTML = "<p>No logs yet.</p>";
        h.forEach(x => {
            const div = document.createElement('div');
            div.style.marginBottom = '1rem'; div.style.borderLeft = '4px solid var(--primary)'; div.style.padding = '10px'; div.style.background = 'rgba(0,0,0,0.2)';
            div.innerHTML = `<h3>${x.date} - ${x.title}</h3>` + x.sets.map(s => `<div>â€¢ ${s.exercise}: <strong>${s.weight}kg</strong></div>`).join('');
            l.appendChild(div);
        });
        document.getElementById('historyModal').style.display = 'flex';
    }
    
    function clearHistory() {
        if(confirm("Are you sure? This will delete all your past workout logs.")) {
            localStorage.removeItem('workout_history');
            showHistory(); 
        }
    }

    function triggerInitialCalculation() { ['Squat','Bench Press','Deadlift'].forEach(l => { const v=localStorage.getItem('1rm_'+l); if(v) updateMax(l,v); }); }
    window.updateMax = function(l, w) {
        localStorage.setItem('1rm_'+l, w);
        const key = l.toLowerCase().replace(" press","");
        document.querySelectorAll('tr.main-row').forEach(row => {
            if(row.getAttribute('data-exercise').toLowerCase().includes(key)) {
                const pct = parseFloat(row.getAttribute('data-pct'));
                const cell = row.querySelector('.load-cell');
                const load = (w && pct>0) ? Math.round((w*pct)/2.5)*2.5 : 0;
                cell.innerText = load || "-"; cell.setAttribute('data-actual-load', load);
                updateAttachedBackoffs(row, load);
            }
        });
    }
    window.updateRowRPE = function(sel) {
        const row = sel.closest('tr');
        row.setAttribute('data-pct', rpeChart[row.getAttribute('data-reps')][sel.value]);
        const ex = row.getAttribute('data-exercise').toLowerCase();
        let l=null; if(ex.includes('squat'))l='Squat'; else if(ex.includes('bench'))l='Bench Press'; else if(ex.includes('deadlift'))l='Deadlift';
        if(l) updateMax(l, localStorage.getItem('1rm_'+l));
    }
    function updateAttachedBackoffs(main, load) {
        let n = main.nextElementSibling;
        while(n && (n.classList.contains('backoff-row')||n.classList.contains('warmup-row'))) {
            if(n.classList.contains('backoff-row')) recalculateBackoff(n.querySelector('.tiny-input'));
            n = n.nextElementSibling;
        }
    }
    window.recalculateBackoff = function(inp) {
        const row = inp.closest('tr');
        let m = row.previousElementSibling;
        while(m && !m.classList.contains('main-row')) m = m.previousElementSibling;
        if(m) {
            const base = parseFloat(m.querySelector('.load-cell').getAttribute('data-actual-load'));
            const cell = row.querySelector('.backoff-load');
            cell.innerText = (base>0) ? Math.round((base * (1 - inp.value/100))/2.5)*2.5 : "-";
        }
    }
    window.addManualBackoff = function(btn) { createBackoffRow(btn.closest('tr').parentNode, btn.closest('tr'), {exercise:'Backoff', drop:10}); }
</script>
</body>
</html>
